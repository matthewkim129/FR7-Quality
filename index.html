<!DOCTYPE html>
<html lang="ko" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FR7 일일 품질개선 보고</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .thin-scroll::-webkit-scrollbar{width:8px;height:8px}
    .thin-scroll::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:6px}
    .thin-scroll::-webkit-scrollbar-track{background:transparent}
    .drag-over{outline:2px dashed #60a5fa; outline-offset:4px}
    table.calendar {border-collapse: collapse; width: 100%;}
    table.calendar th, table.calendar td {border: 1px solid #e2e8f0; text-align: center; padding: 4px; font-size: 12px;}
    table.calendar td.marked {background-color:#bfdbfe; font-weight:bold; cursor:pointer;}
    .ratio-16x9 { aspect-ratio: 16 / 9; }
    .cmp-box { background:#000; }
    .cmp-box img { width:100%; height:100%; object-fit:contain; }
    .stepper { display:flex; align-items:center; gap:6px; }
    .btn-step { padding:2px 8px; border-radius:6px; border:1px solid #cbd5e1; font-size:12px; background:#f8fafc; }
    .value-pill { min-width:44px; text-align:center; font-variant-numeric: tabular-nums; }
  </style>
</head>
<body class="h-full bg-slate-50 text-slate-900">
  <div id="app" class="h-full flex">
    <!-- Sidebar -->
    <aside class="w-80 bg-white border-r border-slate-200 flex flex-col">
      <div class="p-4 border-b flex items-center justify-between">
        <h1 class="text-lg font-bold">FR7 일일 보고</h1>
      </div>
      <div class="p-3 border-b space-y-2">
        <button id="newReportBtn" class="w-full py-2 rounded-xl bg-blue-600 text-white font-semibold hover:bg-blue-700">+ 새 보고서</button>
      </div>

      <div id="reportList" class="flex-1 overflow-y-auto thin-scroll divide-y"></div>
      <div class="p-3 border-t">
        <h2 class="text-sm font-semibold mb-2">달력</h2>
        <div id="calendarContainer"></div>
      </div>
      <div class="p-3 text-xs text-slate-400 border-t">로컬 저장소(LocalStorage/IndexedDB)에 저장됩니다.</div>
    </aside>

    <!-- Main -->
    <main class="flex-1 overflow-hidden">
      <!-- Top bar -->
      <div class="px-5 py-3 bg-white border-b flex items-center gap-3">
        <input id="reportTitle" class="text-lg font-bold flex-1 outline-none bg-transparent" placeholder="보고서 제목 (예: 2025-08-27 FR7 품질개선 일일 보고)" />
        <div id="autosaveState" class="text-xs text-slate-500">저장 상태: -</div>
      </div>

      <!-- Tabs -->
      <div class="px-5 pt-4 bg-white border-b">
        <div class="flex gap-2 text-sm">
          <button data-tab="tab-summary" class="tab-btn px-3 py-2 rounded-t bg-slate-100 font-semibold">요약</button>
          <button data-tab="tab-detail" class="tab-btn px-3 py-2 rounded-t">세부</button>
        </div>
      </div>

      <!-- 요약 -->
      <section id="tab-summary" class="tab-pane p-5 overflow-y-auto thin-scroll h-[calc(100vh-136px)]">
        <div class="bg-white rounded-xl shadow p-4">
          <div class="flex items-center justify-between mb-2">
            <h2 class="font-semibold">오늘의 요약</h2>
            <button id="autoSummaryBtn" class="px-3 py-2 rounded bg-indigo-600 text-white text-sm hover:bg-indigo-700">
              세부 내용으로 요약 자동생성
            </button>
          </div>
          <textarea id="summary" class="w-full min-h-40 rounded border p-3 text-sm"
            placeholder="세부 탭 내용을 기반으로 요약됩니다. (기본정보/체크리스트 제외)"></textarea>
        </div>
      </section>

      <!-- 세부 -->
      <section id="tab-detail" class="tab-pane hidden p-5 overflow-y-auto thin-scroll h-[calc(100vh-136px)]">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <!-- 과정 -->
          <div class="bg-white rounded-xl shadow p-4">
            <div class="flex items-center justify-between mb-2">
              <h2 class="font-semibold">과정</h2>
              <label class="text-sm flex items-center gap-2">
                <input id="detailDone" type="checkbox" class="w-4 h-4"> 세부 작성 완료 시 자동 요약
              </label>
            </div>
            <textarea id="process" class="w-full min-h-40 rounded border p-3 text-sm"
              placeholder="이전 진행 사항 / 오늘 수정·시도 / 새롭게 알게 된 점 / 문제 & 해결"></textarea>
          </div>

          <!-- 결과·측정 -->
          <div class="bg-white rounded-xl shadow p-4">
            <h2 class="font-semibold mb-3">결과·측정</h2>
            <div class="grid grid-cols-2 gap-3 text-sm">
              <!-- F -->
              <label class="space-y-1"><span class="text-slate-600">F (조리개)</span>
                <input id="fAperture" type="text" class="w-full rounded border p-2" placeholder="예: F4.0" />
              </label>

              <!-- ISO (역순) -->
              <label class="space-y-1"><span class="text-slate-600">ISO</span>
                <select id="iso" class="w-full rounded border p-2">
                  <option value="">선택</option>
                  <option>25600</option><option>20000</option><option>16000</option><option>12800</option>
                  <option>10000</option><option>8000</option><option>6400</option><option>5000</option>
                  <option>4000</option><option>3200</option><option>2500</option><option>2000</option>
                  <option>1600</option><option>1250</option><option>1000</option><option>800</option>
                  <option>640</option><option>500</option><option>400</option><option>320</option>
                </select>
              </label>

              <!-- WB + stepper -->
              <label class="space-y-1"><span class="text-slate-600">WB (화이트밸런스)</span>
                <div class="space-y-2">
                  <div class="stepper">
                    <button id="wbMinus" class="btn-step" type="button">−100</button>
                    <span class="value-pill text-slate-700 font-mono" id="valWB">5600</span>
                    <button id="wbPlus" class="btn-step" type="button">＋100</button>
                  </div>
                  <input id="wb" type="range" min="2800" max="8000" step="100" value="5600" class="w-full">
                </div>
              </label>

              <!-- Tint + stepper -->
              <label class="space-y-1"><span class="text-slate-600">Tint</span>
                <div class="space-y-2">
                  <div class="stepper">
                    <button id="tintMinus" class="btn-step" type="button">−1</button>
                    <span class="value-pill text-slate-700 font-mono" id="valTint">0</span>
                    <button id="tintPlus" class="btn-step" type="button">＋1</button>
                  </div>
                  <input id="tint" type="range" min="-99" max="99" step="1" value="0" class="w-full">
                </div>
              </label>

              <!-- Shutter (드롭다운) -->
              <label class="space-y-1"><span class="text-slate-600">셔터</span>
                <select id="shutter" class="w-full rounded border p-2">
                  <option value="">선택</option>
                  <option>1/30</option><option>1/40</option><option>1/50</option><option>1/60</option>
                  <option>1/100</option><option>1/120</option><option>1/125</option><option>1/250</option>
                  <option>1/500</option><option>1/1000</option>
                </select>
              </label>

              <!-- FPS (먼저) -->
              <label class="space-y-1"><span class="text-slate-600">FPS</span>
                <select id="fps" class="w-full rounded border p-2">
                  <option value="">선택</option>
                  <option>29.97</option>
                  <option>30</option>
                  <option>59.94</option>
                  <option>60</option>
                </select>
              </label>

              <!-- Scene (나중) -->
              <label class="space-y-1"><span class="text-slate-600">장면파일</span>
                <select id="sceneFile" class="w-full rounded border p-2">
                  <option value="">선택</option>
                  <option value="S-Cinetone">S-Cinetone</option>
                  <option value="Standard">Standard</option>
                  <option value="Still">Still</option>
                  <option value="ITU709">ITU709</option>
                </select>
              </label>
            </div>

            <!-- 블랙 레벨 슬라이더 + stepper -->
            <div class="mt-4 grid grid-cols-1 gap-4">
              <div>
                <div class="flex items-center justify-between">
                  <span class="text-sm text-slate-600">Master Black</span>
                  <div class="stepper">
                    <button id="mbMinus" class="btn-step" type="button">−1</button>
                    <span id="valMasterBlack" class="value-pill text-slate-700 font-mono">0</span>
                    <button id="mbPlus" class="btn-step" type="button">＋1</button>
                  </div>
                </div>
                <input id="masterBlack" type="range" min="-99" max="99" step="1" value="0" class="w-full mt-1">
              </div>
              <div>
                <div class="flex items-center justify-between">
                  <span class="text-sm text-slate-600">R Black</span>
                  <div class="stepper">
                    <button id="rbMinus" class="btn-step" type="button">−1</button>
                    <span id="valRBlack" class="value-pill text-slate-700 font-mono">0</span>
                    <button id="rbPlus" class="btn-step" type="button">＋1</button>
                  </div>
                </div>
                <input id="rBlack" type="range" min="-99" max="99" step="1" value="0" class="w-full mt-1">
              </div>
              <div>
                <div class="flex items-center justify-between">
                  <span class="text-sm text-slate-600">B Black</span>
                  <div class="stepper">
                    <button id="bbMinus" class="btn-step" type="button">−1</button>
                    <span id="valBBlack" class="value-pill text-slate-700 font-mono">0</span>
                    <button id="bbPlus" class="btn-step" type="button">＋1</button>
                  </div>
                </div>
                <input id="bBlack" type="range" min="-99" max="99" step="1" value="0" class="w-full mt-1">
              </div>
            </div>

            <!-- 메모 / 추가 사항 -->
            <div class="mt-4">
              <label class="text-sm text-slate-600">메모 / 추가 사항</label>
              <textarea id="memo" class="w-full min-h-28 rounded border p-3 text-sm" placeholder="추가적인 디테일을 기록하세요."></textarea>
            </div>
          </div>

          <!-- 이미지 비교 (A/B 추가만) -->
          <div class="bg-white rounded-xl shadow p-4 lg:col-span-2">
            <div class="flex items-center justify-between mb-3">
              <h2 class="font-semibold">이미지 비교 (A / B)</h2>
              <div class="flex gap-2">
                <label class="cursor-pointer text-xs px-2 py-1 rounded bg-slate-700 text-white hover:bg-slate-800">A 이미지 추가
                  <input id="cmpAInput" type="file" accept="image/*" class="hidden">
                </label>
                <label class="cursor-pointer text-xs px-2 py-1 rounded bg-slate-700 text-white hover:bg-slate-800">B 이미지 추가
                  <input id="cmpBInput" type="file" accept="image/*" class="hidden">
                </label>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="cmp-box ratio-16x9 rounded-lg overflow-hidden flex items-center justify-center">
                <img id="cmpA" alt="비교 A" />
              </div>
              <div class="cmp-box ratio-16x9 rounded-lg overflow-hidden flex items-center justify-center">
                <img id="cmpB" alt="비교 B" />
              </div>
            </div>
            <div class="mt-2 text-xs text-slate-500" id="cmpNames"></div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ========= Utilities =========
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
    const KST = {
      nowString(){ return new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul', hour12: false }); },
      todayISO(){ const d = new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Seoul' })); return d.toISOString().slice(0,10); }
    };

    // ========= State =========
    const LS_KEY = 'fr7-daily-reports-v8';
    let state = { reports: [], currentId: null };
    function loadState(){ try{ const raw = localStorage.getItem(LS_KEY); if(raw){ state = JSON.parse(raw); } }catch(e){ console.warn('loadState error', e); } }
    function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); const s=$('#autosaveState'); if(s) s.textContent = '저장 상태: ' + new Date().toLocaleTimeString(); }

    // ========= IndexedDB for blobs =========
    const idb = (()=>{ let db;
      function open(){ return new Promise((resolve, reject)=>{ const req = indexedDB.open('fr7ReportsDB', 1);
        req.onupgradeneeded = e=>{ db = e.target.result; if(!db.objectStoreNames.contains('blobs')) db.createObjectStore('blobs'); };
        req.onsuccess = e=>{ db = e.target.result; resolve(); };
        req.onerror = e=>reject(e);
      }); }
      async function put(key, data){ await openIfNeeded(); return new Promise((res,rej)=>{ const tx=db.transaction('blobs','readwrite'); tx.objectStore('blobs').put(data, key); tx.oncomplete=()=>res(); tx.onerror=e=>rej(e); }); }
      async function get(key){ await openIfNeeded(); return new Promise((res,rej)=>{ const tx=db.transaction('blobs','readonly'); const rq=tx.objectStore('blobs').get(key); rq.onsuccess=()=>res(rq.result); rq.onerror=e=>rej(e); }); }
      async function openIfNeeded(){ if(!db) await open(); }
      return { put, get };
    })();

    // ========= Model =========
    function createEmptyReport(){
      const id = 'r_' + Math.random().toString(36).slice(2);
      return {
        id,
        title: KST.todayISO() + ' FR7 품질개선 일일 보고',
        dateKST: KST.todayISO(),    // 달력 표시용 (YYYY-MM-DD로 시작)
        summary: '',
        process: '',
        fields: {
          fAperture: '',
          iso: '',
          wb: 5600,
          tint: 0,
          shutter: '',
          sceneFile: '',
          fps: '',
          masterBlack: 0, rBlack: 0, bBlack: 0,
          memo: ''
        },
        compare: { A: { name:'', blobKey:null }, B: { name:'', blobKey:null } },
        flags: { detailDone: false }
      };
    }
    function getCurrent(){ return state.reports.find(r=>r.id===state.currentId) || null; }
    function setCurrent(id){ state.currentId = id; saveState(); renderReportList(); renderEditor(); }

    // ========= Rendering =========
    function renderReportList(){
      const box = $('#reportList'); if(!box) return; box.innerHTML = '';
      const sorted = [...state.reports].sort((a,b)=> (b.dateKST||'').localeCompare(a.dateKST||''));
      for(const r of sorted){
        const isActive = r.id===state.currentId;
        const item = document.createElement('button');
        item.className = 'w-full text-left p-3 hover:bg-slate-50 ' + (isActive?'bg-blue-50':'');
        item.innerHTML = `<div class="font-semibold truncate">${escapeHtml(r.title||'(제목 없음)')}</div><div class="text-xs text-slate-500">${escapeHtml(r.dateKST||'')}</div>`;
        item.onclick = ()=> setCurrent(r.id);
        box.appendChild(item);
      }
    }

    function renderEditor(){
      const r = getCurrent(); if(!r) return;
      $('#reportTitle').value = r.title||'';
      $('#summary').value = r.summary||'';
      $('#process').value = r.process||'';

      const f = r.fields||{};
      setVal('fAperture', f.fAperture);
      setVal('iso', f.iso);
      setVal('wb', f.wb); text('#valWB', f.wb);
      setVal('tint', f.tint); text('#valTint', f.tint);
      setVal('shutter', f.shutter);
      setVal('fps', f.fps);
      setVal('sceneFile', f.sceneFile);
      setVal('masterBlack', f.masterBlack??0); text('#valMasterBlack', f.masterBlack??0);
      setVal('rBlack', f.rBlack??0);           text('#valRBlack',    f.rBlack??0);
      setVal('bBlack', f.bBlack??0);           text('#valBBlack',    f.bBlack??0);
      setVal('memo', f.memo);

      const dd = $('#detailDone'); if(dd) dd.checked = !!(r.flags&&r.flags.detailDone);

      loadCompare('A'); loadCompare('B');
    }
    function setVal(id, val){ const el=document.getElementById(id); if(el!=null) el.value = val ?? ''; }
    function text(sel, v){ const el=$(sel); if(el) el.textContent = String(v); }

    // ========= Compare =========
    async function loadCompare(which){
      const r = getCurrent(); if(!r) return;
      const c = r.compare[which]; const imgEl = which==='A'? $('#cmpA'): $('#cmpB'); const names = $('#cmpNames');
      if(!imgEl) return;
      imgEl.src = '';
      if(c && c.blobKey){ const blob = await idb.get(c.blobKey); if(blob){ imgEl.src = URL.createObjectURL(blob); } }
      if(names){ names.textContent = `${r.compare.A?.name||''}  |  ${r.compare.B?.name||''}`.trim(); }
    }

    // ========= Events =========
    function bindInputs(){
      // Tabs
      $$('.tab-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id=btn.dataset.tab;
          $$('.tab-btn').forEach(b=> b.classList.remove('bg-slate-100','font-semibold'));
          btn.classList.add('bg-slate-100','font-semibold');
          $$('.tab-pane').forEach(p=> p.classList.add('hidden'));
          const pane = document.getElementById(id);
          if(pane) pane.classList.remove('hidden');
        });
      });

      // Title & summary
      $('#reportTitle')?.addEventListener('input', ()=>{ const r=getCurrent(); if(!r) return; r.title=$('#reportTitle').value; saveState(); });
      $('#summary')?.addEventListener('input', ()=>{ const r=getCurrent(); if(!r) return; r.summary=$('#summary').value; saveState(); });

      // Auto-summary controls
      $('#autoSummaryBtn')?.addEventListener('click', ()=> autoSummarize(true));
      const done=$('#detailDone'); if(done) done.addEventListener('change', ()=>{ const r=getCurrent(); if(!r) return; r.flags.detailDone = done.checked; saveState(); if(done.checked) autoSummarize(true); });

      // Process
      $('#process')?.addEventListener('input', ()=>{ const r=getCurrent(); if(!r) return; r.process=$('#process').value; saveState(); if(r.flags?.detailDone) autoSummarize(); });

      // Fields (text/select/range)
      const bind=(id,key,isRange=false,dispId=null)=>{ const el=$('#'+id); if(!el) return;
        el.addEventListener('input', ()=>{ const r=getCurrent(); if(!r) return; r.fields=r.fields||{};
          r.fields[key]= isRange ? (Number(el.value)) : el.value;
          if(dispId){ const dEl=$('#'+dispId); if(dEl) dEl.textContent=String(r.fields[key]); }
          saveState(); if(r.flags?.detailDone) autoSummarize();
        });
      };
      bind('fAperture','fAperture');
      bind('iso','iso');               // select
      bind('wb','wb',true,'valWB');    // range
      bind('tint','tint',true,'valTint');
      bind('shutter','shutter');       // select
      bind('fps','fps');               // select
      bind('sceneFile','sceneFile');   // select
      bind('masterBlack','masterBlack',true,'valMasterBlack');
      bind('rBlack','rBlack',true,'valRBlack');
      bind('bBlack','bBlack',true,'valBBlack');
      bind('memo','memo');

      // Stepper buttons for ranges
      attachStepper('wb', 100, 2800, 8000, 'valWB');
      attachStepper('tint', 1, -99, 99, 'valTint');
      attachStepper('masterBlack', 1, -99, 99, 'valMasterBlack', 'mbMinus', 'mbPlus');
      attachStepper('rBlack', 1, -99, 99, 'valRBlack', 'rbMinus', 'rbPlus');
      attachStepper('bBlack', 1, -99, 99, 'valBBlack', 'bbMinus', 'bbPlus');

      // Compare inputs
      $('#cmpAInput')?.addEventListener('change', async (e)=>{ const f=e.target.files?.[0]; if(!f) return; const r=getCurrent(); if(!r) return; const key='b_'+Math.random().toString(36).slice(2); await idb.put(key, f); r.compare.A={ name:f.name, blobKey:key }; saveState(); loadCompare('A'); if(r.flags?.detailDone) autoSummarize(); });
      $('#cmpBInput')?.addEventListener('change', async (e)=>{ const f=e.target.files?.[0]; if(!f) return; const r=getCurrent(); if(!r) return; const key='b_'+Math.random().toString(36).slice(2); await idb.put(key, f); r.compare.B={ name:f.name, blobKey:key }; saveState(); loadCompare('B'); if(r.flags?.detailDone) autoSummarize(); });

      // New report
      $('#newReportBtn')?.addEventListener('click', ()=>{ const r=createEmptyReport(); state.reports.push(r); setCurrent(r.id); });
    }

    // ======== Stepper Helper ========
    function attachStepper(id, step, min, max, displayId, minusId, plusId){
      const input = document.getElementById(id);
      if(!input) return;
      const minus = document.getElementById(minusId || (id+'Minus'));
      const plus  = document.getElementById(plusId  || (id+'Plus'));
      const disp  = document.getElementById(displayId);
      function clamp(v){ return Math.max(min, Math.min(max, v)); }
      function set(v){
        input.value = clamp(v);
        if(disp) disp.textContent = String(input.value);
        input.dispatchEvent(new Event('input', { bubbles:true }));
      }
      minus?.addEventListener('click', ()=> set(Number(input.value||0) - step));
      plus ?.addEventListener('click', ()=> set(Number(input.value||0) + step));
    }

    // ======== Auto Summarizer ========
    function autoSummarize(focusSummaryTab=false){
      const r=getCurrent(); if(!r) return;
      const f=r.fields||{};
      const lines=[];
      if(r.process) lines.push(`과정: ${compact(r.process, 140)}`);

      const parts=[];
      const add=(k,v)=>{ if(v!=='' && v!=null) parts.push(`${k}=${v}`); };
      add('F', f.fAperture); add('ISO', f.iso);
      add('WB', f.wb); add('Tint', f.tint);
      add('셔터', f.shutter); add('FPS', f.fps); add('장면', f.sceneFile);
      if(parts.length) lines.push('측정: ' + parts.join(', '));

      if(Number.isFinite(f.masterBlack)||Number.isFinite(f.rBlack)||Number.isFinite(f.bBlack)){
        lines.push(`블랙 M/R/B: ${f.masterBlack??0}/${f.rBlack??0}/${f.bBlack??0}`);
      }

      const cmpA=r.compare?.A?.name||''; const cmpB=r.compare?.B?.name||''; if(cmpA||cmpB) lines.push(`비교: ${cmpA||'-'} vs ${cmpB||'-'}`);
      if(f.memo) lines.push(`메모: ${compact(f.memo, 120)}`);

      const final = lines.length? ('• ' + lines.join('\n• ')) : '';
      r.summary = final; saveState(); const sEl=$('#summary'); if(sEl) sEl.value = final;
      if(focusSummaryTab){ const btn=[...document.querySelectorAll('.tab-btn')].find(b=>b.dataset.tab==='tab-summary'); if(btn) btn.click(); }
    }
    function compact(txt,max=140){ txt=String(txt).trim().replace(/\s+/g,' '); if(txt.length<=max) return txt; return txt.slice(0,max-1)+'…'; }

    // ========= Calendar =========
    function setCurrentByDate(dateStr){
      const candidates = state.reports.filter(r => (r.dateKST||'').startsWith(dateStr));
      if(!candidates.length) return;
      candidates.sort((a,b)=> (b.dateKST||'').localeCompare(a.dateKST||''));
      const pick = candidates[0];
      state.currentId = pick.id; saveState(); renderReportList(); renderEditor();
    }
    function renderCalendar(){
      const container=$('#calendarContainer'); if(!container) return;
      const now=new Date(); const year=now.getFullYear(); const month=now.getMonth();
      const firstDay=new Date(year,month,1); const lastDay=new Date(year,month+1,0);
      let html='<table class="calendar"><thead><tr>';
      const days=['일','월','화','수','목','금','토']; for(const d of days) html+='<th>'+d+'</th>';
      html+='</tr></thead><tbody><tr>';
      for(let i=0;i<firstDay.getDay();i++){ html+='<td></td>'; }
      for(let d=1;d<=lastDay.getDate();d++){
        const dateStr=year+'-'+String(month+1).padStart(2,'0')+'-'+String(d).padStart(2,'0');
        const marked=state.reports.some(r=>(r.dateKST||'').startsWith(dateStr));
        html+=`<td class="date-cell ${marked?'marked':''}" data-date="${dateStr}">${d}</td>`;
        if((firstDay.getDay()+d)%7===0) html+='</tr><tr>';
      }
      html+='</tr></tbody></table>';
      container.innerHTML=html;
      container.querySelectorAll('td.date-cell.marked').forEach(td=>{
        td.addEventListener('click', ()=>{ const ds=td.getAttribute('data-date'); setCurrentByDate(ds); });
      });
    }

    // ========= Helpers =========
    function escapeHtml(s=''){ return s.replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }

    // ========= Boot =========
    const origSave = saveState; saveState = function(){ origSave(); renderCalendar(); };
    function boot(){
      loadState();
      if(!state.reports.length){ const r=createEmptyReport(); state.reports.push(r); state.currentId=r.id; saveState(); }
      else if(!state.currentId){ state.currentId=state.reports[0].id; saveState(); }
      renderReportList(); bindInputs(); renderEditor(); renderCalendar();
    }
    document.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
