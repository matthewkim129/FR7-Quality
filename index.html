<!DOCTYPE html>
<html lang="ko" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FR7 ì¼ì¼ í’ˆì§ˆê°œì„  ë³´ê³  (í´ë¼ìš°ë“œ ë™ê¸°í™”)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .thin-scroll::-webkit-scrollbar{width:8px;height:8px}
    .thin-scroll::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:6px}
    .thin-scroll::-webkit-scrollbar-track{background:transparent}
    .drag-over{outline:2px dashed #60a5fa; outline-offset:4px}
    table.calendar {border-collapse: collapse; width: 100%;}
    table.calendar th, table.calendar td {border: 1px solid #e2e8f0; text-align: center; padding: 4px; font-size: 12px;}
    table.calendar td.marked {background-color:#bfdbfe; font-weight:bold; cursor:pointer;}
    .ratio-16x9 { aspect-ratio: 16 / 9; }
    .cmp-box { background:#000; }
    .cmp-box img { width:100%; height:100%; object-fit:contain; }
    .stepper { display:flex; align-items:center; gap:6px; }
    .btn-step { padding:2px 8px; border-radius:6px; border:1px solid #cbd5e1; font-size:12px; background:#f8fafc; }
    .value-pill { min-width:44px; text-align:center; font-variant-numeric: tabular-nums; }
  </style>
</head>
<body class="h-full bg-slate-50 text-slate-900">
  <div id="app" class="h-full flex">
    <aside class="w-80 bg-white border-r border-slate-200 flex flex-col">
      <div class="p-4 border-b flex items-center justify-between">
        <h1 class="text-lg font-bold">FR7 í”„ë ˆì„ í€„ë¦¬í‹° í–¥ìƒ ê¸°ë¡</h1>
      </div>
      <div class="p-3 border-b space-y-2">
        <button id="newReportBtn" class="w-full py-2 rounded-xl bg-blue-600 text-white font-semibold hover:bg-blue-700">+ ìƒˆ ë³´ê³ ì„œ</button>
      </div>

      <div id="reportList" class="flex-1 overflow-y-auto thin-scroll divide-y"></div>

      <div class="p-3 border-t space-y-2">
        <div class="flex items-center justify-between">
          <button id="calPrev" class="px-2 py-1 rounded bg-slate-100 text-sm">â—€ï¸ ì „ì›”</button>
          <div id="calLabel" class="text-sm font-semibold">-</div>
          <button id="calNext" class="px-2 py-1 rounded bg-slate-100 text-sm">ë‹¤ìŒì›” â–¶ï¸</button>
        </div>
        <div id="calendarContainer"></div>
      </div>

      <div class="p-3 text-xs text-slate-400 border-t">â˜ï¸ Google Drive & Sheetsì— ìë™ ë™ê¸°í™”ë©ë‹ˆë‹¤.</div>
    </aside>

    <main class="flex-1 overflow-hidden">
      <div class="px-5 py-3 bg-white border-b flex items-center gap-3">
        <input id="reportTitle" class="text-lg font-bold flex-1 outline-none bg-transparent" placeholder="ë³´ê³ ì„œ ì œëª© (ì˜ˆ: 2025-08-27 FR7 í’ˆì§ˆê°œì„  ì¼ì¼ ë³´ê³ )" />
        <div id="autosaveState" class="text-xs text-slate-500">ì €ì¥ ìƒíƒœ: -</div>
      </div>

      <div class="px-5 pt-4 bg-white border-b">
        <div class="flex gap-2 text-sm">
          <button data-tab="tab-summary" class="tab-btn px-3 py-2 rounded-t bg-slate-100 font-semibold">ìš”ì•½</button>
          <button data-tab="tab-detail" class="tab-btn px-3 py-2 rounded-t">ì„¸ë¶€</button>
        </div>
      </div>

      <section id="tab-summary" class="tab-pane p-5 overflow-y-auto thin-scroll h-[calc(100vh-136px)]">
        <div class="bg-white rounded-xl shadow p-4 mb-4">
          <h2 class="font-semibold mb-3">ë¹„êµ (A / B)</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="cmp-box ratio-16x9 rounded-lg overflow-hidden flex items-center justify-center">
              <img id="sumCmpA" alt="ìš”ì•½ í”„ë¦¬ë·° A" />
            </div>
            <div class="cmp-box ratio-16x9 rounded-lg overflow-hidden flex items-center justify-center">
              <img id="sumCmpB" alt="ìš”ì•½ í”„ë¦¬ë·° B" />
            </div>
          </div>
          <div class="mt-2 text-xs text-slate-500" id="sumCmpNames"></div>
        </div>

        <div class="bg-white rounded-xl shadow p-4">
          <div class="flex items-center justify-between mb-2">
            <h2 class="font-semibold">ì˜¤ëŠ˜ì˜ ìš”ì•½</h2>
            <button id="autoSummaryBtn" class="px-3 py-2 rounded bg-indigo-600 text-white text-sm hover:bg-indigo-700">
              ì„¸ë¶€ ë‚´ìš©ìœ¼ë¡œ ìš”ì•½ ìë™ìƒì„±
            </button>
          </div>
          <textarea id="summary" class="w-full min-h-40 rounded border p-3 text-sm"
            placeholder="ì„¸ë¶€ íƒ­ ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ìš”ì•½ë©ë‹ˆë‹¤. (ê¸°ë³¸ì •ë³´/ì²´í¬ë¦¬ìŠ¤íŠ¸ ì œì™¸)"></textarea>
        </div>
      </section>

      <section id="tab-detail" class="tab-pane hidden p-5 overflow-y-auto thin-scroll h-[calc(100vh-136px)]">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">

          <div class="bg-white rounded-xl shadow p-4 lg:col-span-2">
            <h2 class="font-semibold mb-3">ë³´ê³ ì„œ ì‘ì„± ì¼ì</h2>
            <input id="reportDate" type="date" class="rounded border p-2 text-sm" />
            <p class="text-xs text-slate-500 mt-2">â€» ê³¼ê±° ë‚ ì§œì˜ ë³´ê³ ì„œë¥¼ ì‘ì„±í•  ë•Œ ì´ ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”. (ë‹¬ë ¥ í‘œì‹œì— ë°˜ì˜ë©ë‹ˆë‹¤)</p>
          </div>

          <div class="bg-white rounded-xl shadow p-4 lg:col-span-2">
            <div class="flex items-center justify-between mb-2">
              <h2 class="font-semibold">ê³¼ì •</h2>
              <label class="text-sm flex items-center gap-2">
                <input id="detailDone" type="checkbox" class="w-4 h-4"> ì„¸ë¶€ ì‘ì„± ì™„ë£Œ ì‹œ ìë™ ìš”ì•½
              </label>
            </div>
            <textarea id="process" class="w-full min-h-40 rounded border p-3 text-sm"
              placeholder="ì´ì „ ì§„í–‰ ì‚¬í•­ / ì˜¤ëŠ˜ ìˆ˜ì •Â·ì‹œë„ / ìƒˆë¡­ê²Œ ì•Œê²Œ ëœ ì  / ë¬¸ì œ & í•´ê²°"></textarea>
          </div>

          <div class="bg-white rounded-xl shadow p-4">
            <h2 class="font-semibold mb-3">ê²°ê³¼Â·ì¸¡ì •</h2>
            <div class="grid grid-cols-2 gap-3 text-sm">
              <label class="space-y-1"><span class="text-slate-600">F (ì¡°ë¦¬ê°œ)</span>
                <input id="fAperture" type="text" class="w-full rounded border p-2" placeholder="ì˜ˆ: F4.0" />
              </label>

              <label class="space-y-1"><span class="text-slate-600">ISO</span>
                <select id="iso" class="w-full rounded border p-2">
                  <option value="">ì„ íƒ</option>
                  <option>25600</option><option>20000</option><option>16000</option><option>12800</option>
                  <option>10000</option><option>8000</option><option>6400</option><option>5000</option>
                  <option>4000</option><option>3200</option><option>2500</option><option>2000</option>
                  <option>1600</option><option>1250</option><option>1000</option><option>800</option>
                  <option>640</option><option>500</option><option>400</option><option>320</option>
                </select>
              </label>

              <label class="space-y-1"><span class="text-slate-600">WB (í™”ì´íŠ¸ë°¸ëŸ°ìŠ¤)</span>
                <div class="space-y-2">
                  <div class="stepper">
                    <button id="wbMinus" class="btn-step" type="button">âˆ’100</button>
                    <span class="value-pill text-slate-700 font-mono" id="valWB">5600</span>
                    <button id="wbPlus" class="btn-step" type="button">ï¼‹100</button>
                  </div>
                  <input id="wb" type="range" min="2800" max="8000" step="100" value="5600" class="w-full">
                </div>
              </label>

              <label class="space-y-1"><span class="text-slate-600">Tint</span>
                <div class="space-y-2">
                  <div class="stepper">
                    <button id="tintMinus" class="btn-step" type="button">âˆ’1</button>
                    <span class="value-pill text-slate-700 font-mono" id="valTint">0</span>
                    <button id="tintPlus" class="btn-step" type="button">ï¼‹1</button>
                  </div>
                  <input id="tint" type="range" min="-99" max="99" step="1" value="0" class="w-full">
                </div>
              </label>

              <label class="space-y-1"><span class="text-slate-600">ì…”í„°</span>
                <select id="shutter" class="w-full rounded border p-2">
                  <option value="">ì„ íƒ</option>
                  <option>1/30</option><option>1/40</option><option>1/50</option><option>1/60</option>
                  <option>1/100</option><option>1/120</option><option>1/125</option><option>1/250</option>
                  <option>1/500</option><option>1/1000</option>
                </select>
              </label>

              <label class="space-y-1"><span class="text-slate-600">FPS</span>
                <select id="fps" class="w-full rounded border p-2">
                  <option value="">ì„ íƒ</option>
                  <option>29.97</option>
                  <option>30</option>
                  <option>59.94</option>
                  <option>60</option>
                </select>
              </label>

              <label class="space-y-1"><span class="text-slate-600">ì¥ë©´íŒŒì¼</span>
                <select id="sceneFile" class="w-full rounded border p-2">
                  <option value="">ì„ íƒ</option>
                  <option value="S-Cinetone">S-Cinetone</option>
                  <option value="Standard">Standard</option>
                  <option value="Still">Still</option>
                  <option value="ITU709">ITU709</option>
                </select>
              </label>
            </div>

            <div class="mt-4 grid grid-cols-1 gap-4">
              <div>
                <div class="flex items-center justify-between">
                  <span class="text-sm text-slate-600">Master Black</span>
                  <div class="stepper">
                    <button id="mbMinus" class="btn-step" type="button">âˆ’1</button>
                    <span id="valMasterBlack" class="value-pill text-slate-700 font-mono">0</span>
                    <button id="mbPlus" class="btn-step" type="button">ï¼‹1</button>
                  </div>
                </div>
                <input id="masterBlack" type="range" min="-99" max="99" step="1" value="0" class="w-full mt-1">
              </div>
              <div>
                <div class="flex items-center justify-between">
                  <span class="text-sm text-slate-600">R Black</span>
                  <div class="stepper">
                    <button id="rbMinus" class="btn-step" type="button">âˆ’1</button>
                    <span id="valRBlack" class="value-pill text-slate-700 font-mono">0</span>
                    <button id="rbPlus" class="btn-step" type="button">ï¼‹1</button>
                  </div>
                </div>
                <input id="rBlack" type="range" min="-99" max="99" step="1" value="0" class="w-full mt-1">
              </div>
              <div>
                <div class="flex items-center justify-between">
                  <span class="text-sm text-slate-600">B Black</span>
                  <div class="stepper">
                    <button id="bbMinus" class="btn-step" type="button">âˆ’1</button>
                    <span id="valBBlack" class="value-pill text-slate-700 font-mono">0</span>
                    <button id="bbPlus" class="btn-step" type="button">ï¼‹1</button>
                  </div>
                </div>
                <input id="bBlack" type="range" min="-99" max="99" step="1" value="0" class="w-full mt-1">
              </div>
            </div>

            <div class="mt-4">
              <label class="text-sm text-slate-600">ë©”ëª¨ / ì¶”ê°€ ì‚¬í•­</label>
              <textarea id="memo" class="w-full min-h-28 rounded border p-3 text-sm" placeholder="ì¶”ê°€ì ì¸ ë””í…Œì¼ì„ ê¸°ë¡í•˜ì„¸ìš”."></textarea>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow p-4 lg:col-span-2">
            <div class="flex items-center justify-between mb-3">
              <h2 class="font-semibold">ì´ë¯¸ì§€ ë¹„êµ (A / B)</h2>
              <div class="flex gap-2">
                <label class="cursor-pointer text-xs px-2 py-1 rounded bg-slate-700 text-white hover:bg-slate-800">A ì´ë¯¸ì§€ ì¶”ê°€
                  <input id="cmpAInput" type="file" accept="image/*" class="hidden">
                </label>
                <label class="cursor-pointer text-xs px-2 py-1 rounded bg-slate-700 text-white hover:bg-slate-800">B ì´ë¯¸ì§€ ì¶”ê°€
                  <input id="cmpBInput" type="file" accept="image/*" class="hidden">
                </label>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="cmp-box ratio-16x9 rounded-lg overflow-hidden flex items-center justify-center">
                <img id="cmpA" alt="ë¹„êµ A" />
              </div>
              <div class="cmp-box ratio-16x9 rounded-lg overflow-hidden flex items-center justify-center">
                <img id="cmpB" alt="ë¹„êµ B" />
              </div>
            </div>
            <div class="mt-2 text-xs text-slate-500" id="cmpNames"></div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ========= Utilities =========
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
    const KST = {
      nowString(){ return new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul', hour12: false }); },
      todayISO(){ const d = new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Seoul' })); return d.toISOString().slice(0,10); }
    };
    function pad2(n){ return String(n).padStart(2,'0'); }

    // === ğŸš€ ìƒˆë¡œ ì¶”ê°€ëœ ë¶€ë¶„: í´ë¼ìš°ë“œ ì—°ë™ ì„¤ì • ===
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyDdd8pk4zU75pyxEuqNC0DYg77soCQHqY_he7dYt9rGrmmo1Vyo2QXUpSWWqtULEA/exec";
    // ==========================================

    // ========= State =========
    let state = { reports: [], currentId: null };

    // calendar view state
    let calView = (()=>{ const t = new Date(); return { y: t.getFullYear(), m: t.getMonth() }; })();

    // === ğŸš€ ìˆ˜ì •ëœ ë¶€ë¶„: ë°ì´í„° ë¡œë”© ë° ì €ì¥ í•¨ìˆ˜ ===
    // ë””ë°”ìš´ìŠ¤ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ (ì¦ì€ ì €ì¥ ìš”ì²­ ë°©ì§€ìš©)
    function debounce(func, delay) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), delay);
      };
    }

    // í´ë¼ìš°ë“œì—ì„œ ì „ì²´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” í•¨ìˆ˜
    async function loadState() {
      $('#autosaveState').textContent = 'ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...';
      try {
        const response = await fetch(`${WEB_APP_URL}`); // GET ìš”ì²­ì€ action íŒŒë¼ë¯¸í„° ë¶ˆí•„ìš”
        if (!response.ok) throw new Error('Network response was not ok.');
        const data = await response.json();
        if (data && data.reports) {
          state = data;
          console.log('í´ë¼ìš°ë“œì—ì„œ ë°ì´í„° ë¡œë“œ ì„±ê³µ');
          $('#autosaveState').textContent = 'ë°ì´í„° ë¡œë“œ ì™„ë£Œ';
        } else {
           throw new Error('Invalid data structure from server.');
        }
      } catch (e) {
        console.warn('loadState error', e);
        $('#autosaveState').textContent = 'ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨';
        state = { reports: [], currentId: null };
      }
    }

    // í´ë¼ìš°ë“œì— ì „ì²´ ë°ì´í„°ë¥¼ ì €ì¥í•˜ëŠ” í•¨ìˆ˜ (ë””ë°”ìš´ìŠ¤ ì ìš©)
    const saveState = debounce(async () => {
      const s = $('#autosaveState');
      if (s) s.textContent = 'ì €ì¥ ì¤‘...';

      try {
        const response = await fetch(`${WEB_APP_URL}?action=save`, {
          method: 'POST',
          // mode: 'no-cors' ë¥¼ ì œê±°í•´ì•¼ ì‘ë‹µì„ ì œëŒ€ë¡œ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. Apps Scriptì—ì„œ CORSë¥¼ ì²˜ë¦¬í•©ë‹ˆë‹¤.
          body: JSON.stringify(state),
          headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // Apps Scriptì˜ doPost í•œê³„ ë•Œë¬¸ì— text/plainìœ¼ë¡œ ì „ì†¡
        });
        const result = await response.json();
        if (result.result === 'success') {
          if (s) s.textContent = 'ì €ì¥ ìƒíƒœ: ' + new Date().toLocaleTimeString();
        } else {
           throw new Error(result.message || 'Save operation failed.');
        }
      } catch (e) {
        console.error('saveState error', e);
        if (s) s.textContent = 'ì €ì¥ ì‹¤íŒ¨';
      }
    }, 1500); // 1.5ì´ˆ ë™ì•ˆ ì…ë ¥ì´ ì—†ìœ¼ë©´ ì €ì¥
    // ==========================================

    // === âŒ ì‚­ì œëœ ë¶€ë¶„: IndexedDB ì½”ë“œ ===
    // idb ê´€ë ¨ ì½”ë“œëŠ” ëª¨ë‘ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.
    // ====================================

    // ========= Model =========
    function createEmptyReport(){
      const id = 'r_' + Math.random().toString(36).slice(2);
      return {
        id,
        title: KST.todayISO() + ' FR7 í’ˆì§ˆê°œì„  ì¼ì¼ ë³´ê³ ',
        reportDate: KST.todayISO(),
        summary: '',
        process: '',
        fields: {
          fAperture: '', iso: '', wb: 5600, tint: 0, shutter: '',
          sceneFile: '', fps: '', masterBlack: 0, rBlack: 0, bBlack: 0, memo: ''
        },
        // ğŸš€ ìˆ˜ì •ëœ ë¶€ë¶„: blobKey -> imageUrl
        compare: { A: { name:'', imageUrl:'' }, B: { name:'', imageUrl:'' } },
        flags: { detailDone: false }
      };
    }
    function getCurrent(){ return state.reports.find(r=>r.id===state.currentId) || null; }
    function setCurrent(id){ state.currentId = id; saveState(); renderReportList(); renderEditor(); } // renderCalendarëŠ” saveStateì—ì„œ í˜¸ì¶œ

    // ========= Rendering =========
    function renderReportList(){
      const box = $('#reportList'); if(!box) return; box.innerHTML = '';
      const sorted = [...state.reports].sort((a,b)=> (b.reportDate||'').localeCompare(a.reportDate||''));
      for(const r of sorted){
        const isActive = r.id===state.currentId;
        const dateTxt = r.reportDate || '';
        const item = document.createElement('button');
        item.className = 'w-full text-left p-3 hover:bg-slate-50 ' + (isActive?'bg-blue-50':'');
        item.innerHTML = `<div class="font-semibold truncate">${escapeHtml(r.title||'(ì œëª© ì—†ìŒ)')}</div><div class="text-xs text-slate-500">${escapeHtml(dateTxt)}</div>`;
        item.onclick = ()=> setCurrent(r.id);
        box.appendChild(item);
      }
    }

    function renderEditor(){
      const r = getCurrent();
      const main = $('main'); if(!main) return;
      if (!r) {
        main.classList.add('hidden'); // ì„ íƒëœ ë³´ê³ ì„œ ì—†ìœ¼ë©´ ë©”ì¸ ìˆ¨ê¹€
        return;
      }
      main.classList.remove('hidden');

      $('#reportTitle').value = r.title||'';
      $('#summary').value = r.summary||'';
      $('#reportDate').value = r.reportDate || KST.todayISO();
      $('#process').value = r.process||'';

      const f = r.fields||{};
      setVal('fAperture', f.fAperture); setVal('iso', f.iso);
      setVal('wb', f.wb); text('#valWB', f.wb);
      setVal('tint', f.tint); text('#valTint', f.tint);
      setVal('shutter', f.shutter); setVal('fps', f.fps);
      setVal('sceneFile', f.sceneFile);
      setVal('masterBlack', f.masterBlack??0); text('#valMasterBlack', f.masterBlack??0);
      setVal('rBlack', f.rBlack??0);         text('#valRBlack',    f.rBlack??0);
      setVal('bBlack', f.bBlack??0);         text('#valBBlack',    f.bBlack??0);
      setVal('memo', f.memo);

      $('#detailDone').checked = !!(r.flags&&r.flags.detailDone);

      loadCompare('A'); loadCompare('B');
    }
    function setVal(id, val){ const el=document.getElementById(id); if(el!=null) el.value = val ?? ''; }
    function text(sel, v){ const el=$(sel); if(el) el.textContent = String(v); }

    // ========= Compare (update detail + summary) =========
    // ğŸš€ ìˆ˜ì •ëœ ë¶€ë¶„: IndexedDB ëŒ€ì‹  imageUrl ì‚¬ìš©
    function loadCompare(which) {
      const r = getCurrent(); if (!r) return;
      const c = r.compare[which];
      const imageUrl = c ? c.imageUrl : '';

      const imgEl = which === 'A' ? $('#cmpA') : $('#cmpB');
      if (imgEl) imgEl.src = imageUrl || '';

      const sImgEl = which === 'A' ? $('#sumCmpA') : $('#sumCmpB');
      if (sImgEl) sImgEl.src = imageUrl || '';

      const nameA = r.compare.A?.name || '';
      const nameB = r.compare.B?.name || '';
      const names = `${nameA} | ${nameB}`.trim();
      $('#cmpNames').textContent = names;
      $('#sumCmpNames').textContent = names;
    }

    // ========= Events =========
    function bindInputs(){
      // Tabs
      $$('.tab-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id=btn.dataset.tab;
          $$('.tab-btn').forEach(b=> b.classList.remove('bg-slate-100','font-semibold'));
          btn.classList.add('bg-slate-100','font-semibold');
          $$('.tab-pane').forEach(p=> p.classList.add('hidden'));
          $('#'+id)?.classList.remove('hidden');
        });
      });

      // Title & summary
      $('#reportTitle')?.addEventListener('input', ()=>{ const r=getCurrent(); if(!r) return; r.title=$('#reportTitle').value; saveState(); });
      $('#summary')?.addEventListener('input', ()=>{ const r=getCurrent(); if(!r) return; r.summary=$('#summary').value; saveState(); });

      // Auto-summary controls
      $('#autoSummaryBtn')?.addEventListener('click', ()=> autoSummarize(true));
      $('#detailDone')?.addEventListener('change', ()=>{ const r=getCurrent(); if(!r) return; r.flags.detailDone = $('#detailDone').checked; saveState(); if($('#detailDone').checked) autoSummarize(true); });

      // Report Date
      $('#reportDate')?.addEventListener('change', ()=>{
        const r=getCurrent(); if(!r) return;
        r.reportDate = $('#reportDate').value;
        saveState(); renderReportList();
      });

      // Process
      $('#process')?.addEventListener('input', ()=>{ const r=getCurrent(); if(!r) return; r.process=$('#process').value; saveState(); if(r.flags?.detailDone) autoSummarize(); });

      // Fields
      const bind=(id,key,isRange=false,dispId=null)=>{ const el=$('#'+id); if(!el) return;
        el.addEventListener('input', ()=>{ const r=getCurrent(); if(!r) return; r.fields=r.fields||{};
          r.fields[key]= isRange ? (Number(el.value)) : el.value;
          if(dispId){ $('#'+dispId).textContent=String(r.fields[key]); }
          saveState(); if(r.flags?.detailDone) autoSummarize();
        });
      };
      bind('fAperture','fAperture'); bind('iso','iso');
      bind('wb','wb',true,'valWB'); bind('tint','tint',true,'valTint');
      bind('shutter','shutter'); bind('fps','fps'); bind('sceneFile','sceneFile');
      bind('masterBlack','masterBlack',true,'valMasterBlack');
      bind('rBlack','rBlack',true,'valRBlack');
      bind('bBlack','bBlack',true,'valBBlack');
      bind('memo','memo');

      // Stepper buttons
      attachStepper('wb', 100, 2800, 8000, 'valWB');
      attachStepper('tint', 1, -99, 99, 'valTint');
      attachStepper('masterBlack', 1, -99, 99, 'valMasterBlack', 'mbMinus', 'mbPlus');
      attachStepper('rBlack', 1, -99, 99, 'valRBlack', 'rbMinus', 'rbPlus');
      attachStepper('bBlack', 1, -99, 99, 'valBBlack', 'bbMinus', 'bbPlus');

      // === ğŸš€ ìƒˆë¡œ ì¶”ê°€ëœ ë¶€ë¶„: ì´ë¯¸ì§€ ì—…ë¡œë“œ ê³µí†µ í•¨ìˆ˜ ===
      async function uploadImage(file) {
        const reader = new FileReader();
        return new Promise((resolve, reject) => {
          reader.readAsDataURL(file);
          reader.onload = async () => {
            try {
              const response = await fetch(`${WEB_APP_URL}?action=uploadImage`, {
                method: 'POST',
                body: JSON.stringify({
                  imageData: reader.result,
                  fileName: file.name,
                  mimeType: file.type
                }),
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
              });
              const result = await response.json();
              if (result.result === 'success') {
                resolve(result.fileUrl); // ì„±ê³µ ì‹œ íŒŒì¼ URL ë°˜í™˜
              } else {
                reject(new Error(result.message || 'Upload failed'));
              }
            } catch (error) {
              reject(error);
            }
          };
          reader.onerror = error => reject(error);
        });
      }

      // === ğŸš€ ìˆ˜ì •ëœ ë¶€ë¶„: ì´ë¯¸ì§€ ì—…ë¡œë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ===
      async function handleImageUpload(which, file) {
        const r = getCurrent(); if (!r) return;
        const s = $('#autosaveState');
        s.textContent = `${which} ì´ë¯¸ì§€ ì—…ë¡œë“œ ì¤‘...`;

        try {
          const imageUrl = await uploadImage(file);
          r.compare[which] = { name: file.name, imageUrl: imageUrl };
          s.textContent = `${which} ì´ë¯¸ì§€ ì—…ë¡œë“œ ì™„ë£Œ`;
          saveState();
          loadCompare(which);
          if (r.flags?.detailDone) autoSummarize();
        } catch (error) {
          s.textContent = `${which} ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨`;
          alert(`${which} ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨! ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.`);
          console.error(error);
        }
      }

      $('#cmpAInput')?.addEventListener('change', (e) => {
        const file = e.target.files?.[0]; if (file) handleImageUpload('A', file);
      });
      $('#cmpBInput')?.addEventListener('change', (e) => {
        const file = e.target.files?.[0]; if (file) handleImageUpload('B', file);
      });
      // ===============================================

      // New report
      $('#newReportBtn')?.addEventListener('click', ()=>{
        const r = createEmptyReport();
        state.reports.push(r);
        setCurrent(r.id);
      });
    }

    // ======== Stepper Helper ========
    function attachStepper(id, step, min, max, displayId, minusId, plusId){
      const input = $('#'+id); if(!input) return;
      const minus = $('#'+(minusId || (id+'Minus')));
      const plus  = $('#'+(plusId  || (id+'Plus')));
      const disp  = $('#'+displayId);
      function clamp(v){ return Math.max(min, Math.min(max, v)); }
      function set(v){
        input.value = clamp(v);
        if(disp) disp.textContent = String(input.value);
        input.dispatchEvent(new Event('input', { bubbles:true }));
      }
      minus?.addEventListener('click', ()=> set(Number(input.value||0) - step));
      plus ?.addEventListener('click', ()=> set(Number(input.value||0) + step));
    }

    // ======== Auto Summarizer ========
    function autoSummarize(focusSummaryTab=false){
      const r=getCurrent(); if(!r) return;
      const f=r.fields||{};
      const lines=[];
      if(r.process) lines.push(`ê³¼ì •: ${compact(r.process, 140)}`);

      const parts=[];
      const add=(k,v)=>{ if(v!=='' && v!=null) parts.push(`${k}=${v}`); };
      add('F', f.fAperture); add('ISO', f.iso); add('WB', f.wb); add('Tint', f.tint);
      add('ì…”í„°', f.shutter); add('FPS', f.fps); add('ì¥ë©´', f.sceneFile);
      if(parts.length) lines.push('ì¸¡ì •: ' + parts.join(', '));
      if(Number.isFinite(f.masterBlack)||Number.isFinite(f.rBlack)||Number.isFinite(f.bBlack)){
        lines.push(`ë¸”ë™ M/R/B: ${f.masterBlack??0}/${f.rBlack??0}/${f.bBlack??0}`);
      }
      const cmpA=r.compare?.A?.name||''; const cmpB=r.compare?.B?.name||''; if(cmpA||cmpB) lines.push(`ë¹„êµ: ${cmpA||'-'} vs ${cmpB||'-'}`);
      if(f.memo) lines.push(`ë©”ëª¨: ${compact(f.memo, 120)}`);

      const final = lines.length? ('â€¢ ' + lines.join('\nâ€¢ ')) : '';
      r.summary = final; saveState(); $('#summary').value = final;
      if(focusSummaryTab){ $$('.tab-btn').find(b=>b.dataset.tab==='tab-summary')?.click(); }
    }
    function compact(txt,max=140){ txt=String(txt).trim().replace(/\s+/g,' '); if(txt.length<=max) return txt; return txt.slice(0,max-1)+'â€¦'; }

    // ========= Calendar (with navigation) =========
    function setCurrentByDate(dateStr){
      const candidates = state.reports.filter(r => (r.reportDate||'').startsWith(dateStr));
      if(!candidates.length) return;
      candidates.sort((a,b)=> (b.reportDate||'').localeCompare(a.reportDate||''));
      setCurrent(candidates[0].id);
    }
    function changeMonth(delta){
      let y = calView.y, m = calView.m + delta;
      if(m < 0){ m = 11; y -= 1; } if(m > 11){ m = 0;  y += 1; }
      calView = { y, m };
      renderCalendar();
    }
    function renderCalendar(){
      const container=$('#calendarContainer'); if(!container) return;
      const year=calView.y, month=calView.m;
      const firstDay=new Date(year,month,1), lastDay=new Date(year,month+1,0);
      $('#calLabel').textContent = `${year}ë…„ ${month+1}ì›”`;

      let html='<table class="calendar"><thead><tr><th>ì¼</th><th>ì›”</th><th>í™”</th><th>ìˆ˜</th><th>ëª©</th><th>ê¸ˆ</th><th>í† </th></tr></thead><tbody><tr>';
      for(let i=0;i<firstDay.getDay();i++){ html+='<td></td>'; }
      for(let d=1;d<=lastDay.getDate();d++){
        const dateStr=year+'-'+pad2(month+1)+'-'+pad2(d);
        const marked=state.reports.some(r=> (r.reportDate||'').startsWith(dateStr));
        html+=`<td class="date-cell ${marked?'marked':''}" data-date="${dateStr}">${d}</td>`;
        if((firstDay.getDay()+d)%7===0) html+='</tr><tr>';
      }
      html+='</tr></tbody></table>';
      container.innerHTML=html;
      $$('td.date-cell.marked', container).forEach(td=>{
        td.addEventListener('click', ()=> setCurrentByDate(td.dataset.date));
      });
    }

    // ========= Helpers =========
    function escapeHtml(s=''){ return String(s).replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }

    // ========= Boot =========
    const origSave = saveState;
    saveState = function(){ origSave(); renderCalendar(); };

    // ğŸš€ ìˆ˜ì •ëœ ë¶€ë¶„: ë¹„ë™ê¸° ë¶€íŒ… í•¨ìˆ˜
    async function boot() {
      await loadState(); // ë°ì´í„°ë¥¼ ëª¨ë‘ ë¶ˆëŸ¬ì˜¬ ë•Œê¹Œì§€ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.

      if (!state.reports.length) {
        const r = createEmptyReport();
        state.reports.push(r);
        state.currentId = r.id;
        saveState();
      } else if (!state.currentId || !state.reports.some(r => r.id === state.currentId)) {
        // ê°€ì¥ ìµœê·¼ ë³´ê³ ì„œë¥¼ í˜„ì¬ ë³´ê³ ì„œë¡œ ì„¤ì •
        const sorted = [...state.reports].sort((a,b)=> (b.reportDate||'').localeCompare(a.reportDate||''));
        state.currentId = sorted.length > 0 ? sorted[0].id : null;
      }
      
      renderReportList();
      bindInputs();
      renderEditor();
      renderCalendar();

      $('#calPrev')?.addEventListener('click', () => changeMonth(-1));
      $('#calNext')?.addEventListener('click', () => changeMonth(+1));
    }
    document.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
