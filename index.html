<!DOCTYPE html>
<html lang="ko" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FR7 일일 품질개선 보고 (클라우드 동기화)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .thin-scroll::-webkit-scrollbar{width:8px;height:8px}
    .thin-scroll::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:6px}
    .thin-scroll::-webkit-scrollbar-track{background:transparent}
    .drag-over{outline:2px dashed #60a5fa; outline-offset:4px}
    table.calendar {border-collapse: collapse; width: 100%;}
    table.calendar th, table.calendar td {border: 1px solid #e2e8f0; text-align: center; padding: 4px; font-size: 12px;}
    table.calendar td.marked {background-color:#bfdbfe; font-weight:bold; cursor:pointer;}
    .ratio-16x9 { aspect-ratio: 16 / 9; }
    .cmp-box { background:#000; }
    .cmp-box img { width:100%; height:100%; object-fit:contain; }
    .stepper { display:flex; align-items:center; gap:6px; }
    .btn-step { padding:2px 8px; border-radius:6px; border:1px solid #cbd5e1; font-size:12px; background:#f8fafc; }
    .value-pill { min-width:44px; text-align:center; font-variant-numeric: tabular-nums; }
  </style>
</head>
<body class="h-full bg-slate-50 text-slate-900">
  <div id="app" class="h-full flex">
    <aside class="w-80 bg-white border-r border-slate-200 flex flex-col">
      <div class="p-4 border-b flex items-center justify-between">
        <h1 class="text-lg font-bold">FR7 프레임 퀄리티 향상 기록</h1>
      </div>
      <div class="p-3 border-b space-y-2">
        <button id="newReportBtn" class="w-full py-2 rounded-xl bg-blue-600 text-white font-semibold hover:bg-blue-700">+ 새 보고서</button>
      </div>

      <div id="reportList" class="flex-1 overflow-y-auto thin-scroll divide-y"></div>

      <div class="p-3 border-t space-y-2">
        <div class="flex items-center justify-between">
          <button id="calPrev" class="px-2 py-1 rounded bg-slate-100 text-sm">◀︎ 전월</button>
          <div id="calLabel" class="text-sm font-semibold">-</div>
          <button id="calNext" class="px-2 py-1 rounded bg-slate-100 text-sm">다음월 ▶︎</button>
        </div>
        <div id="calendarContainer"></div>
      </div>

      <div class="p-3 text-xs text-slate-400 border-t">☁️ Google Drive & Sheets에 자동 동기화됩니다.</div>
    </aside>

    <main class="flex-1 overflow-hidden">
      <div class="px-5 py-3 bg-white border-b flex items-center gap-3">
        <input id="reportTitle" class="text-lg font-bold flex-1 outline-none bg-transparent" placeholder="보고서 제목 (예: 2025-08-27 FR7 품질개선 일일 보고)" />
        <div id="autosaveState" class="text-xs text-slate-500">저장 상태: -</div>
      </div>

      <div class="px-5 pt-4 bg-white border-b">
        <div class="flex gap-2 text-sm">
          <button data-tab="tab-summary" class="tab-btn px-3 py-2 rounded-t bg-slate-100 font-semibold">요약</button>
          <button data-tab="tab-detail" class="tab-btn px-3 py-2 rounded-t">세부</button>
        </div>
      </div>

      <section id="tab-summary" class="tab-pane p-5 overflow-y-auto thin-scroll h-[calc(100vh-136px)]">
        <div class="bg-white rounded-xl shadow p-4 mb-4">
          <h2 class="font-semibold mb-3">비교 (A / B)</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="cmp-box ratio-16x9 rounded-lg overflow-hidden flex items-center justify-center">
              <img id="sumCmpA" alt="요약 프리뷰 A" />
            </div>
            <div class="cmp-box ratio-16x9 rounded-lg overflow-hidden flex items-center justify-center">
              <img id="sumCmpB" alt="요약 프리뷰 B" />
            </div>
          </div>
          <div class="mt-2 text-xs text-slate-500" id="sumCmpNames"></div>
        </div>

        <div class="bg-white rounded-xl shadow p-4">
          <div class="flex items-center justify-between mb-2">
            <h2 class="font-semibold">오늘의 요약</h2>
            <button id="autoSummaryBtn" class="px-3 py-2 rounded bg-indigo-600 text-white text-sm hover:bg-indigo-700">
              세부 내용으로 요약 자동생성
            </button>
          </div>
          <textarea id="summary" class="w-full min-h-40 rounded border p-3 text-sm"
            placeholder="세부 탭 내용을 기반으로 요약됩니다. (기본정보/체크리스트 제외)"></textarea>
        </div>
      </section>

      <section id="tab-detail" class="tab-pane hidden p-5 overflow-y-auto thin-scroll h-[calc(100vh-136px)]">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">

          <div class="bg-white rounded-xl shadow p-4 lg:col-span-2">
            <h2 class="font-semibold mb-3">보고서 작성 일자</h2>
            <input id="reportDate" type="date" class="rounded border p-2 text-sm" />
            <p class="text-xs text-slate-500 mt-2">※ 과거 날짜의 보고서를 작성할 때 이 날짜를 선택하세요. (달력 표시에 반영됩니다)</p>
          </div>

          <div class="bg-white rounded-xl shadow p-4 lg:col-span-2">
            <div class="flex items-center justify-between mb-2">
              <h2 class="font-semibold">과정</h2>
              <label class="text-sm flex items-center gap-2">
                <input id="detailDone" type="checkbox" class="w-4 h-4"> 세부 작성 완료 시 자동 요약
              </label>
            </div>
            <textarea id="process" class="w-full min-h-40 rounded border p-3 text-sm"
              placeholder="이전 진행 사항 / 오늘 수정·시도 / 새롭게 알게 된 점 / 문제 & 해결"></textarea>
          </div>

          <div class="bg-white rounded-xl shadow p-4">
            <h2 class="font-semibold mb-3">결과·측정</h2>
            <div class="grid grid-cols-2 gap-3 text-sm">
              <label class="space-y-1"><span class="text-slate-600">F (조리개)</span>
                <input id="fAperture" type="text" class="w-full rounded border p-2" placeholder="예: F4.0" />
              </label>

              <label class="space-y-1"><span class="text-slate-600">ISO</span>
                <select id="iso" class="w-full rounded border p-2">
                  <option value="">선택</option>
                  <option>25600</option><option>20000</option><option>16000</option><option>12800</option>
                  <option>10000</option><option>8000</option><option>6400</option><option>5000</option>
                  <option>4000</option><option>3200</option><option>2500</option><option>2000</option>
                  <option>1600</option><option>1250</option><option>1000</option><option>800</option>
                  <option>640</option><option>500</option><option>400</option><option>320</option>
                </select>
              </label>

              <label class="space-y-1"><span class="text-slate-600">WB (화이트밸런스)</span>
                <div class="space-y-2">
                  <div class="stepper">
                    <button id="wbMinus" class="btn-step" type="button">−100</button>
                    <span class="value-pill text-slate-700 font-mono" id="valWB">5600</span>
                    <button id="wbPlus" class="btn-step" type="button">＋100</button>
                  </div>
                  <input id="wb" type="range" min="2800" max="8000" step="100" value="5600" class="w-full">
                </div>
              </label>

              <label class="space-y-1"><span class="text-slate-600">Tint</span>
                <div class="space-y-2">
                  <div class="stepper">
                    <button id="tintMinus" class="btn-step" type="button">−1</button>
                    <span class="value-pill text-slate-700 font-mono" id="valTint">0</span>
                    <button id="tintPlus" class="btn-step" type="button">＋1</button>
                  </div>
                  <input id="tint" type="range" min="-99" max="99" step="1" value="0" class="w-full">
                </div>
              </label>

              <label class="space-y-1"><span class="text-slate-600">셔터</span>
                <select id="shutter" class="w-full rounded border p-2">
                  <option value="">선택</option>
                  <option>1/30</option><option>1/40</option><option>1/50</option><option>1/60</option>
                  <option>1/100</option><option>1/120</option><option>1/125</option><option>1/250</option>
                  <option>1/500</option><option>1/1000</option>
                </select>
              </label>

              <label class="space-y-1"><span class="text-slate-600">FPS</span>
                <select id="fps" class="w-full rounded border p-2">
                  <option value="">선택</option>
                  <option>29.97</option>
                  <option>30</option>
                  <option>59.94</option>
                  <option>60</option>
                </select>
              </label>

              <label class="space-y-1"><span class="text-slate-600">장면파일</span>
                <select id="sceneFile" class="w-full rounded border p-2">
                  <option value="">선택</option>
                  <option value="S-Cinetone">S-Cinetone</option>
                  <option value="Standard">Standard</option>
                  <option value="Still">Still</option>
                  <option value="ITU709">ITU709</option>
                </select>
              </label>
            </div>

            <div class="mt-4 grid grid-cols-1 gap-4">
              <div>
                <div class="flex items-center justify-between">
                  <span class="text-sm text-slate-600">Master Black</span>
                  <div class="stepper">
                    <button id="mbMinus" class="btn-step" type="button">−1</button>
                    <span id="valMasterBlack" class="value-pill text-slate-700 font-mono">0</span>
                    <button id="mbPlus" class="btn-step" type="button">＋1</button>
                  </div>
                </div>
                <input id="masterBlack" type="range" min="-99" max="99" step="1" value="0" class="w-full mt-1">
              </div>
              <div>
                <div class="flex items-center justify-between">
                  <span class="text-sm text-slate-600">R Black</span>
                  <div class="stepper">
                    <button id="rbMinus" class="btn-step" type="button">−1</button>
                    <span id="valRBlack" class="value-pill text-slate-700 font-mono">0</span>
                    <button id="rbPlus" class="btn-step" type="button">＋1</button>
                  </div>
                </div>
                <input id="rBlack" type="range" min="-99" max="99" step="1" value="0" class="w-full mt-1">
              </div>
              <div>
                <div class="flex items-center justify-between">
                  <span class="text-sm text-slate-600">B Black</span>
                  <div class="stepper">
                    <button id="bbMinus" class="btn-step" type="button">−1</button>
                    <span id="valBBlack" class="value-pill text-slate-700 font-mono">0</span>
                    <button id="bbPlus" class="btn-step" type="button">＋1</button>
                  </div>
                </div>
                <input id="bBlack" type="range" min="-99" max="99" step="1" value="0" class="w-full mt-1">
              </div>
            </div>

            <div class="mt-4">
              <label class="text-sm text-slate-600">메모 / 추가 사항</label>
              <textarea id="memo" class="w-full min-h-28 rounded border p-3 text-sm" placeholder="추가적인 디테일을 기록하세요."></textarea>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow p-4 lg:col-span-2">
            <div class="flex items-center justify-between mb-3">
              <h2 class="font-semibold">이미지 비교 (A / B)</h2>
              <div class="flex gap-2">
                <label class="cursor-pointer text-xs px-2 py-1 rounded bg-slate-700 text-white hover:bg-slate-800">A 이미지 추가
                  <input id="cmpAInput" type="file" accept="image/*" class="hidden">
                </label>
                <label class="cursor-pointer text-xs px-2 py-1 rounded bg-slate-700 text-white hover:bg-slate-800">B 이미지 추가
                  <input id="cmpBInput" type="file" accept="image/*" class="hidden">
                </label>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="cmp-box ratio-16x9 rounded-lg overflow-hidden flex items-center justify-center">
                <img id="cmpA" alt="비교 A" />
              </div>
              <div class="cmp-box ratio-16x9 rounded-lg overflow-hidden flex items-center justify-center">
                <img id="cmpB" alt="비교 B" />
              </div>
            </div>
            <div class="mt-2 text-xs text-slate-500" id="cmpNames"></div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ========= Utilities =========
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
    const KST = {
      nowString(){ return new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul', hour12: false }); },
      todayISO(){ const d = new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Seoul' })); return d.toISOString().slice(0,10); }
    };
    function pad2(n){ return String(n).padStart(2,'0'); }

    // === 🚀 새로 추가된 부분: 클라우드 연동 설정 ===
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyDdd8pk4zU75pyxEuqNC0DYg77soCQHqY_he7dYt9rGrmmo1Vyo2QXUpSWWqtULEA/exec";
    // ==========================================

    // ========= State =========
    let state = { reports: [], currentId: null };

    // calendar view state
    let calView = (()=>{ const t = new Date(); return { y: t.getFullYear(), m: t.getMonth() }; })();

    // === 🚀 수정된 부분: 데이터 로딩 및 저장 함수 ===
    // 디바운스 유틸리티 함수 (잦은 저장 요청 방지용)
    function debounce(func, delay) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), delay);
      };
    }

    // 클라우드에서 전체 데이터를 불러오는 함수
    async function loadState() {
      $('#autosaveState').textContent = '데이터 불러오는 중...';
      try {
        const response = await fetch(`${WEB_APP_URL}`); // GET 요청은 action 파라미터 불필요
        if (!response.ok) throw new Error('Network response was not ok.');
        const data = await response.json();
        if (data && data.reports) {
          state = data;
          console.log('클라우드에서 데이터 로드 성공');
          $('#autosaveState').textContent = '데이터 로드 완료';
        } else {
           throw new Error('Invalid data structure from server.');
        }
      } catch (e) {
        console.warn('loadState error', e);
        $('#autosaveState').textContent = '데이터 로드 실패';
        state = { reports: [], currentId: null };
      }
    }

    // 클라우드에 전체 데이터를 저장하는 함수 (디바운스 적용)
    const saveState = debounce(async () => {
      const s = $('#autosaveState');
      if (s) s.textContent = '저장 중...';

      try {
        const response = await fetch(`${WEB_APP_URL}?action=save`, {
          method: 'POST',
          // mode: 'no-cors' 를 제거해야 응답을 제대로 받을 수 있습니다. Apps Script에서 CORS를 처리합니다.
          body: JSON.stringify(state),
          headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // Apps Script의 doPost 한계 때문에 text/plain으로 전송
        });
        const result = await response.json();
        if (result.result === 'success') {
          if (s) s.textContent = '저장 상태: ' + new Date().toLocaleTimeString();
        } else {
           throw new Error(result.message || 'Save operation failed.');
        }
      } catch (e) {
        console.error('saveState error', e);
        if (s) s.textContent = '저장 실패';
      }
    }, 1500); // 1.5초 동안 입력이 없으면 저장
    // ==========================================

    // === ❌ 삭제된 부분: IndexedDB 코드 ===
    // idb 관련 코드는 모두 제거되었습니다.
    // ====================================

    // ========= Model =========
    function createEmptyReport(){
      const id = 'r_' + Math.random().toString(36).slice(2);
      return {
        id,
        title: KST.todayISO() + ' FR7 품질개선 일일 보고',
        reportDate: KST.todayISO(),
        summary: '',
        process: '',
        fields: {
          fAperture: '', iso: '', wb: 5600, tint: 0, shutter: '',
          sceneFile: '', fps: '', masterBlack: 0, rBlack: 0, bBlack: 0, memo: ''
        },
        // 🚀 수정된 부분: blobKey -> imageUrl
        compare: { A: { name:'', imageUrl:'' }, B: { name:'', imageUrl:'' } },
        flags: { detailDone: false }
      };
    }
    function getCurrent(){ return state.reports.find(r=>r.id===state.currentId) || null; }
    function setCurrent(id){ state.currentId = id; saveState(); renderReportList(); renderEditor(); } // renderCalendar는 saveState에서 호출

    // ========= Rendering =========
    function renderReportList(){
      const box = $('#reportList'); if(!box) return; box.innerHTML = '';
      const sorted = [...state.reports].sort((a,b)=> (b.reportDate||'').localeCompare(a.reportDate||''));
      for(const r of sorted){
        const isActive = r.id===state.currentId;
        const dateTxt = r.reportDate || '';
        const item = document.createElement('button');
        item.className = 'w-full text-left p-3 hover:bg-slate-50 ' + (isActive?'bg-blue-50':'');
        item.innerHTML = `<div class="font-semibold truncate">${escapeHtml(r.title||'(제목 없음)')}</div><div class="text-xs text-slate-500">${escapeHtml(dateTxt)}</div>`;
        item.onclick = ()=> setCurrent(r.id);
        box.appendChild(item);
      }
    }

    function renderEditor(){
      const r = getCurrent();
      const main = $('main'); if(!main) return;
      if (!r) {
        main.classList.add('hidden'); // 선택된 보고서 없으면 메인 숨김
        return;
      }
      main.classList.remove('hidden');

      $('#reportTitle').value = r.title||'';
      $('#summary').value = r.summary||'';
      $('#reportDate').value = r.reportDate || KST.todayISO();
      $('#process').value = r.process||'';

      const f = r.fields||{};
      setVal('fAperture', f.fAperture); setVal('iso', f.iso);
      setVal('wb', f.wb); text('#valWB', f.wb);
      setVal('tint', f.tint); text('#valTint', f.tint);
      setVal('shutter', f.shutter); setVal('fps', f.fps);
      setVal('sceneFile', f.sceneFile);
      setVal('masterBlack', f.masterBlack??0); text('#valMasterBlack', f.masterBlack??0);
      setVal('rBlack', f.rBlack??0);         text('#valRBlack',    f.rBlack??0);
      setVal('bBlack', f.bBlack??0);         text('#valBBlack',    f.bBlack??0);
      setVal('memo', f.memo);

      $('#detailDone').checked = !!(r.flags&&r.flags.detailDone);

      loadCompare('A'); loadCompare('B');
    }
    function setVal(id, val){ const el=document.getElementById(id); if(el!=null) el.value = val ?? ''; }
    function text(sel, v){ const el=$(sel); if(el) el.textContent = String(v); }

    // ========= Compare (update detail + summary) =========
    // 🚀 수정된 부분: IndexedDB 대신 imageUrl 사용
    function loadCompare(which) {
      const r = getCurrent(); if (!r) return;
      const c = r.compare[which];
      const imageUrl = c ? c.imageUrl : '';

      const imgEl = which === 'A' ? $('#cmpA') : $('#cmpB');
      if (imgEl) imgEl.src = imageUrl || '';

      const sImgEl = which === 'A' ? $('#sumCmpA') : $('#sumCmpB');
      if (sImgEl) sImgEl.src = imageUrl || '';

      const nameA = r.compare.A?.name || '';
      const nameB = r.compare.B?.name || '';
      const names = `${nameA} | ${nameB}`.trim();
      $('#cmpNames').textContent = names;
      $('#sumCmpNames').textContent = names;
    }

    // ========= Events =========
    function bindInputs(){
      // Tabs
      $$('.tab-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id=btn.dataset.tab;
          $$('.tab-btn').forEach(b=> b.classList.remove('bg-slate-100','font-semibold'));
          btn.classList.add('bg-slate-100','font-semibold');
          $$('.tab-pane').forEach(p=> p.classList.add('hidden'));
          $('#'+id)?.classList.remove('hidden');
        });
      });

      // Title & summary
      $('#reportTitle')?.addEventListener('input', ()=>{ const r=getCurrent(); if(!r) return; r.title=$('#reportTitle').value; saveState(); });
      $('#summary')?.addEventListener('input', ()=>{ const r=getCurrent(); if(!r) return; r.summary=$('#summary').value; saveState(); });

      // Auto-summary controls
      $('#autoSummaryBtn')?.addEventListener('click', ()=> autoSummarize(true));
      $('#detailDone')?.addEventListener('change', ()=>{ const r=getCurrent(); if(!r) return; r.flags.detailDone = $('#detailDone').checked; saveState(); if($('#detailDone').checked) autoSummarize(true); });

      // Report Date
      $('#reportDate')?.addEventListener('change', ()=>{
        const r=getCurrent(); if(!r) return;
        r.reportDate = $('#reportDate').value;
        saveState(); renderReportList();
      });

      // Process
      $('#process')?.addEventListener('input', ()=>{ const r=getCurrent(); if(!r) return; r.process=$('#process').value; saveState(); if(r.flags?.detailDone) autoSummarize(); });

      // Fields
      const bind=(id,key,isRange=false,dispId=null)=>{ const el=$('#'+id); if(!el) return;
        el.addEventListener('input', ()=>{ const r=getCurrent(); if(!r) return; r.fields=r.fields||{};
          r.fields[key]= isRange ? (Number(el.value)) : el.value;
          if(dispId){ $('#'+dispId).textContent=String(r.fields[key]); }
          saveState(); if(r.flags?.detailDone) autoSummarize();
        });
      };
      bind('fAperture','fAperture'); bind('iso','iso');
      bind('wb','wb',true,'valWB'); bind('tint','tint',true,'valTint');
      bind('shutter','shutter'); bind('fps','fps'); bind('sceneFile','sceneFile');
      bind('masterBlack','masterBlack',true,'valMasterBlack');
      bind('rBlack','rBlack',true,'valRBlack');
      bind('bBlack','bBlack',true,'valBBlack');
      bind('memo','memo');

      // Stepper buttons
      attachStepper('wb', 100, 2800, 8000, 'valWB');
      attachStepper('tint', 1, -99, 99, 'valTint');
      attachStepper('masterBlack', 1, -99, 99, 'valMasterBlack', 'mbMinus', 'mbPlus');
      attachStepper('rBlack', 1, -99, 99, 'valRBlack', 'rbMinus', 'rbPlus');
      attachStepper('bBlack', 1, -99, 99, 'valBBlack', 'bbMinus', 'bbPlus');

      // === 🚀 새로 추가된 부분: 이미지 업로드 공통 함수 ===
      async function uploadImage(file) {
        const reader = new FileReader();
        return new Promise((resolve, reject) => {
          reader.readAsDataURL(file);
          reader.onload = async () => {
            try {
              const response = await fetch(`${WEB_APP_URL}?action=uploadImage`, {
                method: 'POST',
                body: JSON.stringify({
                  imageData: reader.result,
                  fileName: file.name,
                  mimeType: file.type
                }),
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
              });
              const result = await response.json();
              if (result.result === 'success') {
                resolve(result.fileUrl); // 성공 시 파일 URL 반환
              } else {
                reject(new Error(result.message || 'Upload failed'));
              }
            } catch (error) {
              reject(error);
            }
          };
          reader.onerror = error => reject(error);
        });
      }

      // === 🚀 수정된 부분: 이미지 업로드 이벤트 리스너 ===
      async function handleImageUpload(which, file) {
        const r = getCurrent(); if (!r) return;
        const s = $('#autosaveState');
        s.textContent = `${which} 이미지 업로드 중...`;

        try {
          const imageUrl = await uploadImage(file);
          r.compare[which] = { name: file.name, imageUrl: imageUrl };
          s.textContent = `${which} 이미지 업로드 완료`;
          saveState();
          loadCompare(which);
          if (r.flags?.detailDone) autoSummarize();
        } catch (error) {
          s.textContent = `${which} 이미지 업로드 실패`;
          alert(`${which} 이미지 업로드 실패! 콘솔을 확인하세요.`);
          console.error(error);
        }
      }

      $('#cmpAInput')?.addEventListener('change', (e) => {
        const file = e.target.files?.[0]; if (file) handleImageUpload('A', file);
      });
      $('#cmpBInput')?.addEventListener('change', (e) => {
        const file = e.target.files?.[0]; if (file) handleImageUpload('B', file);
      });
      // ===============================================

      // New report
      $('#newReportBtn')?.addEventListener('click', ()=>{
        const r = createEmptyReport();
        state.reports.push(r);
        setCurrent(r.id);
      });
    }

    // ======== Stepper Helper ========
    function attachStepper(id, step, min, max, displayId, minusId, plusId){
      const input = $('#'+id); if(!input) return;
      const minus = $('#'+(minusId || (id+'Minus')));
      const plus  = $('#'+(plusId  || (id+'Plus')));
      const disp  = $('#'+displayId);
      function clamp(v){ return Math.max(min, Math.min(max, v)); }
      function set(v){
        input.value = clamp(v);
        if(disp) disp.textContent = String(input.value);
        input.dispatchEvent(new Event('input', { bubbles:true }));
      }
      minus?.addEventListener('click', ()=> set(Number(input.value||0) - step));
      plus ?.addEventListener('click', ()=> set(Number(input.value||0) + step));
    }

    // ======== Auto Summarizer ========
    function autoSummarize(focusSummaryTab=false){
      const r=getCurrent(); if(!r) return;
      const f=r.fields||{};
      const lines=[];
      if(r.process) lines.push(`과정: ${compact(r.process, 140)}`);

      const parts=[];
      const add=(k,v)=>{ if(v!=='' && v!=null) parts.push(`${k}=${v}`); };
      add('F', f.fAperture); add('ISO', f.iso); add('WB', f.wb); add('Tint', f.tint);
      add('셔터', f.shutter); add('FPS', f.fps); add('장면', f.sceneFile);
      if(parts.length) lines.push('측정: ' + parts.join(', '));
      if(Number.isFinite(f.masterBlack)||Number.isFinite(f.rBlack)||Number.isFinite(f.bBlack)){
        lines.push(`블랙 M/R/B: ${f.masterBlack??0}/${f.rBlack??0}/${f.bBlack??0}`);
      }
      const cmpA=r.compare?.A?.name||''; const cmpB=r.compare?.B?.name||''; if(cmpA||cmpB) lines.push(`비교: ${cmpA||'-'} vs ${cmpB||'-'}`);
      if(f.memo) lines.push(`메모: ${compact(f.memo, 120)}`);

      const final = lines.length? ('• ' + lines.join('\n• ')) : '';
      r.summary = final; saveState(); $('#summary').value = final;
      if(focusSummaryTab){ $$('.tab-btn').find(b=>b.dataset.tab==='tab-summary')?.click(); }
    }
    function compact(txt,max=140){ txt=String(txt).trim().replace(/\s+/g,' '); if(txt.length<=max) return txt; return txt.slice(0,max-1)+'…'; }

    // ========= Calendar (with navigation) =========
    function setCurrentByDate(dateStr){
      const candidates = state.reports.filter(r => (r.reportDate||'').startsWith(dateStr));
      if(!candidates.length) return;
      candidates.sort((a,b)=> (b.reportDate||'').localeCompare(a.reportDate||''));
      setCurrent(candidates[0].id);
    }
    function changeMonth(delta){
      let y = calView.y, m = calView.m + delta;
      if(m < 0){ m = 11; y -= 1; } if(m > 11){ m = 0;  y += 1; }
      calView = { y, m };
      renderCalendar();
    }
    function renderCalendar(){
      const container=$('#calendarContainer'); if(!container) return;
      const year=calView.y, month=calView.m;
      const firstDay=new Date(year,month,1), lastDay=new Date(year,month+1,0);
      $('#calLabel').textContent = `${year}년 ${month+1}월`;

      let html='<table class="calendar"><thead><tr><th>일</th><th>월</th><th>화</th><th>수</th><th>목</th><th>금</th><th>토</th></tr></thead><tbody><tr>';
      for(let i=0;i<firstDay.getDay();i++){ html+='<td></td>'; }
      for(let d=1;d<=lastDay.getDate();d++){
        const dateStr=year+'-'+pad2(month+1)+'-'+pad2(d);
        const marked=state.reports.some(r=> (r.reportDate||'').startsWith(dateStr));
        html+=`<td class="date-cell ${marked?'marked':''}" data-date="${dateStr}">${d}</td>`;
        if((firstDay.getDay()+d)%7===0) html+='</tr><tr>';
      }
      html+='</tr></tbody></table>';
      container.innerHTML=html;
      $$('td.date-cell.marked', container).forEach(td=>{
        td.addEventListener('click', ()=> setCurrentByDate(td.dataset.date));
      });
    }

    // ========= Helpers =========
    function escapeHtml(s=''){ return String(s).replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }

    // ========= Boot =========
    const origSave = saveState;
    saveState = function(){ origSave(); renderCalendar(); };

    // 🚀 수정된 부분: 비동기 부팅 함수
    async function boot() {
      await loadState(); // 데이터를 모두 불러올 때까지 기다립니다.

      if (!state.reports.length) {
        const r = createEmptyReport();
        state.reports.push(r);
        state.currentId = r.id;
        saveState();
      } else if (!state.currentId || !state.reports.some(r => r.id === state.currentId)) {
        // 가장 최근 보고서를 현재 보고서로 설정
        const sorted = [...state.reports].sort((a,b)=> (b.reportDate||'').localeCompare(a.reportDate||''));
        state.currentId = sorted.length > 0 ? sorted[0].id : null;
      }
      
      renderReportList();
      bindInputs();
      renderEditor();
      renderCalendar();

      $('#calPrev')?.addEventListener('click', () => changeMonth(-1));
      $('#calNext')?.addEventListener('click', () => changeMonth(+1));
    }
    document.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
