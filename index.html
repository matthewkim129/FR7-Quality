<!DOCTYPE html>
<html lang="ko" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FR7 일일 품질개선 보고</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .thin-scroll::-webkit-scrollbar{width:8px;height:8px}
    .thin-scroll::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:6px}
    .thin-scroll::-webkit-scrollbar-track{background:transparent}
    .drag-over{outline:2px dashed #60a5fa; outline-offset:4px}
    table.calendar {border-collapse: collapse; width: 100%;}
    table.calendar th, table.calendar td {border: 1px solid #e2e8f0; text-align: center; padding: 4px; font-size: 12px;}
    table.calendar td.marked {background-color:#bfdbfe; font-weight:bold;}
  </style>
</head>
<body class="h-full bg-slate-50 text-slate-900">
  <div id="app" class="h-full flex">
    <!-- Sidebar -->
    <aside class="w-80 bg-white border-r border-slate-200 flex flex-col">
      <div class="p-4 border-b flex items-center justify-between">
        <h1 class="text-lg font-bold">FR7 일일 보고</h1>
      </div>
      <div class="p-3 border-b space-y-2">
        <button id="newReportBtn" class="w-full py-2 rounded-xl bg-blue-600 text-white font-semibold hover:bg-blue-700">+ 새 보고서</button>
        <button id="printBtn" class="w-full py-2 rounded-xl bg-slate-700 text-white text-sm hover:bg-slate-800">인쇄 / PDF</button>
      </div>
      <div id="reportList" class="flex-1 overflow-y-auto thin-scroll divide-y"></div>
      <div class="p-3 border-t">
        <h2 class="text-sm font-semibold mb-2">달력</h2>
        <div id="calendarContainer"></div>
      </div>
      <div class="p-3 text-xs text-slate-400 border-t">로컬 저장소(LocalStorage/IndexedDB)에 저장됩니다.</div>
    </aside>

    <!-- Main -->
    <main class="flex-1 overflow-hidden">
      <!-- Top bar -->
      <div class="px-5 py-3 bg-white border-b flex items-center gap-3">
        <input id="reportTitle" class="text-lg font-bold flex-1 outline-none bg-transparent" placeholder="보고서 제목 (예: 2025-08-27 FR7 품질개선 일일 보고)" />
        <div id="autosaveState" class="text-xs text-slate-500">저장 상태: -</div>
      </div>

      <!-- Tabs -->
      <div class="px-5 pt-4 bg-white border-b">
        <div class="flex gap-2 text-sm">
          <button data-tab="tab-summary" class="tab-btn px-3 py-2 rounded-t bg-slate-100 font-semibold">요약</button>
          <button data-tab="tab-detail" class="tab-btn px-3 py-2 rounded-t">세부</button>
        </div>
      </div>

      <!-- Tab Contents -->
      <section id="tab-summary" class="tab-pane p-5 overflow-y-auto thin-scroll h-[calc(100vh-136px)]">
        <h2 class="font-semibold mb-3">오늘의 요약</h2>
        <textarea id="summary" class="w-full min-h-40 rounded border p-3 text-sm"></textarea>
      </section>

      <section id="tab-detail" class="tab-pane hidden p-5 overflow-y-auto thin-scroll h-[calc(100vh-136px)]">
        <h2 class="font-semibold mb-3">세부 내용</h2>
        <textarea id="process" class="w-full min-h-40 rounded border p-3 text-sm" placeholder="과정"></textarea>
        <textarea id="results" class="w-full min-h-40 rounded border p-3 text-sm mt-4" placeholder="결과·측정"></textarea>
        <div class="mt-4">
          <h3 class="font-semibold mb-2">캡처</h3>
          <div id="imgGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
        </div>
        <div class="mt-4">
          <h3 class="font-semibold mb-2">영상 비교</h3>
          <video id="vidA" class="w-full rounded bg-black mb-2" controls></video>
          <video id="vidB" class="w-full rounded bg-black" controls></video>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ========= Utilities =========
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
    const KST = {
      nowString(){ return new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul', hour12: false }); },
      todayISO(){ const d = new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Seoul' })); return d.toISOString().slice(0,10); }
    };

    // ========= State (LocalStorage + IndexedDB) =========
    const LS_KEY = 'fr7-daily-reports-v2';
    let state = { reports: [], currentId: null };
    function loadState(){ try{ const raw = localStorage.getItem(LS_KEY); if(raw){ state = JSON.parse(raw); } }catch(e){ console.warn('loadState error', e); } }
    function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); const s=$('#autosaveState'); if(s) s.textContent = '저장 상태: ' + new Date().toLocaleTimeString(); }

    // ========= IndexedDB for blobs =========
    const idb = (()=>{ let db; function open(){ return new Promise((resolve, reject)=>{ const req = indexedDB.open('fr7ReportsDB', 1); req.onupgradeneeded = e=>{ db = e.target.result; if(!db.objectStoreNames.contains('blobs')) db.createObjectStore('blobs'); }; req.onsuccess = e=>{ db = e.target.result; resolve(); }; req.onerror = e=>reject(e); }); }
      async function put(key, data){ await openIfNeeded(); return new Promise((res,rej)=>{ const tx=db.transaction('blobs','readwrite'); tx.objectStore('blobs').put(data, key); tx.oncomplete=()=>res(); tx.onerror=e=>rej(e); }); }
      async function get(key){ await openIfNeeded(); return new Promise((res,rej)=>{ const tx=db.transaction('blobs','readonly'); const rq=tx.objectStore('blobs').get(key); rq.onsuccess=()=>res(rq.result); rq.onerror=e=>rej(e); }); }
      async function del(key){ await openIfNeeded(); return new Promise((res,rej)=>{ const tx=db.transaction('blobs','readwrite'); tx.objectStore('blobs').delete(key); tx.oncomplete=()=>res(); tx.onerror=e=>rej(e); }); }
      async function openIfNeeded(){ if(!db) await open(); } return { put, get, del }; })();

    // ========= Model =========
    function createEmptyReport(){
      const id = 'r_' + Math.random().toString(36).slice(2);
      return {
        id,
        title: KST.todayISO() + ' FR7 품질개선 일일 보고',
        dateKST: KST.nowString(),
        project: '', location: '', operator: '', gear: '',
        qc: defaultQC().map(x=>({ ...x })),
        summary: '', process: '',
        metrics: { EV:'', SNR:'', CCT:'', Tint:'', MTF:'', ISO:'', Shutter:'', Aperture:'', Gamma:'', LUT:'' },
        resultSummary:'', nextActions:'',
        images: [], // {id, blobKey, caption, thumbDataUrl}
        videos: { A: { name:'', blobKey:null, offset:0 }, B: { name:'', blobKey:null, offset:0 } }
      };
    }
    function defaultQC(){ return [
      { k:'초점', v:false }, { k:'노출', v:false }, { k:'WB 일치', v:false }, { k:'컬러 매칭', v:false },
      { k:'노이즈', v:false }, { k:'플리커', v:false }, { k:'롤링 셔터', v:false }, { k:'샤프니스', v:false },
      { k:'스태빌라이징', v:false }, { k:'스킨 톤', v:false }, { k:'하이라이트 보존', v:false }, { k:'섀도우 디테일', v:false }
    ]; }

    function getCurrent(){ return state.reports.find(r=>r.id===state.currentId) || null; }
    function setCurrent(id){ state.currentId = id; saveState(); renderReportList(); renderEditor(); }

    // ========= Rendering =========
    function renderReportList(){
      const box = $('#reportList'); if(!box) return; box.innerHTML = '';
      const sorted = [...state.reports].sort((a,b)=> (b.dateKST||'').localeCompare(a.dateKST||''));
      for(const r of sorted){
        const isActive = r.id===state.currentId;
        const item = document.createElement('button');
        item.className = 'w-full text-left p-3 hover:bg-slate-50 ' + (isActive?'bg-blue-50':'');
        item.innerHTML = `<div class="font-semibold truncate">${escapeHtml(r.title||'(제목 없음)')}</div><div class="text-xs text-slate-500">${escapeHtml(r.dateKST||'')}</div>`;
        item.onclick = ()=> setCurrent(r.id);
        box.appendChild(item);
      }
    }

    function renderEditor(){
      const r = getCurrent();
      const disabled = !r;
      const ids = ['reportTitle','dateKST','project','location','operator','gear','summary','process','metricEV','metricSNR','metricCCT','metricTint','metricMTF','metricISO','metricShutter','metricAperture','metricGamma','metricLUT','resultSummary','nextActions'];
      ids.forEach(id=>{ const node = document.getElementById(id); if(node) node.disabled = disabled; });
      if(!r) return;

      // Fill fields
      $('#reportTitle').value = r.title||''; $('#dateKST').value = r.dateKST||KST.nowString();
      $('#project').value = r.project||''; $('#location').value = r.location||''; $('#operator').value = r.operator||''; $('#gear').value = r.gear||'';
      $('#summary').value = r.summary||''; $('#process').value = r.process||'';
      $('#metricEV').value = r.metrics.EV||''; $('#metricSNR').value = r.metrics.SNR||''; $('#metricCCT').value = r.metrics.CCT||''; $('#metricTint').value = r.metrics.Tint||''; $('#metricMTF').value = r.metrics.MTF||''; $('#metricISO').value = r.metrics.ISO||''; $('#metricShutter').value = r.metrics.Shutter||''; $('#metricAperture').value = r.metrics.Aperture||''; $('#metricGamma').value = r.metrics.Gamma||''; $('#metricLUT').value = r.metrics.LUT||'';
      $('#resultSummary').value = r.resultSummary||''; $('#nextActions').value = r.nextActions||'';

      // QC
      const qcBox = $('#qcList'); if(qcBox){ qcBox.innerHTML = ''; (r.qc?.length? r.qc: defaultQC()).forEach((row, idx)=>{ const wrap = document.createElement('label'); wrap.className = 'inline-flex items-center gap-2'; wrap.innerHTML = `<input type="checkbox" ${row.v?'checked':''} data-idx="${idx}" class="qcCheck"> <span class="text-slate-700">${escapeHtml(row.k)}</span>`; qcBox.appendChild(wrap); }); }

      // Images & Videos
      renderImages(); loadVideo('A'); loadVideo('B');
    }

    function renderImages(){
      const r = getCurrent(); const grid = $('#imgGrid'); if(!grid) return; grid.innerHTML = '';
      (r?.images||[]).forEach((img, idx)=>{
        const card = document.createElement('div'); card.className = 'bg-white rounded-xl shadow p-3 space-y-2';
        card.draggable = true; card.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', idx); card.classList.add('opacity-50'); }); card.addEventListener('dragend', ()=> card.classList.remove('opacity-50'));
        card.addEventListener('dragover', e=>{ e.preventDefault(); card.classList.add('drag-over'); }); card.addEventListener('dragleave', ()=> card.classList.remove('drag-over'));
        card.addEventListener('drop', async e=>{ e.preventDefault(); card.classList.remove('drag-over'); const from = parseInt(e.dataTransfer.getData('text/plain'),10); const to = idx; if(from===to) return; const moved = r.images.splice(from,1)[0]; r.images.splice(to,0,moved); saveState(); renderImages(); });
        const imgEl = document.createElement('img'); imgEl.className = 'w-full h-40 object-cover rounded'; imgEl.src = img.thumbDataUrl || ''; imgEl.alt = img.caption || '';
        const cap = document.createElement('input'); cap.className = 'w-full text-xs border rounded p-2'; cap.placeholder='캡션'; cap.value = img.caption||''; cap.oninput = ()=>{ img.caption = cap.value; saveState(); };
        const row = document.createElement('div'); row.className='flex items-center justify-between text-xs';
        const btns = document.createElement('div'); btns.className='flex gap-2';
        const upBtn=document.createElement('button'); upBtn.textContent='▲'; upBtn.className='px-2 py-1 rounded bg-slate-100';
        const dnBtn=document.createElement('button'); dnBtn.textContent='▼'; dnBtn.className='px-2 py-1 rounded bg-slate-100';
        const delBtn=document.createElement('button'); delBtn.textContent='삭제'; delBtn.className='px-2 py-1 rounded bg-red-600 text-white';
        upBtn.onclick=()=>{ if(idx>0){ const t=r.images[idx-1]; r.images[idx-1]=r.images[idx]; r.images[idx]=t; saveState(); renderImages(); } };
        dnBtn.onclick=()=>{ if(idx<r.images.length-1){ const t=r.images[idx+1]; r.images[idx+1]=r.images[idx]; r.images[idx]=t; saveState(); renderImages(); } };
        delBtn.onclick= async ()=>{ if(confirm('이미지를 삭제할까요?')){ await idb.del(img.blobKey); r.images.splice(idx,1); saveState(); renderImages(); } };
        btns.append(upBtn,dnBtn,delBtn); row.append(document.createElement('span'), btns);
        card.append(imgEl, cap, row); grid.appendChild(card);
      });
    }

    // ========= Video Handling =========
    async function loadVideo(which){
      const r = getCurrent(); if(!r) return;
      const v = r.videos[which]; const videoEl = which==='A'? $('#vidA'): $('#vidB'); const nameEl = which==='A'? $('#vidAName'): $('#vidBName'); const offsetEl = which==='A'? $('#vidAOffset'): $('#vidBOffset');
      if(!videoEl) return;
      videoEl.src = '';
      if(v && v.blobKey){ const blob = await idb.get(v.blobKey); if(blob){ videoEl.src = URL.createObjectURL(blob); } }
      if(nameEl) nameEl.textContent = v?.name || '';
      if(offsetEl) offsetEl.value = v?.offset || 0;
    }
    function setPlaybackRate(rate){ const a=$('#vidA'), b=$('#vidB'); if(a) a.playbackRate=rate; if(b) b.playbackRate=rate; }
    function syncFromMasterSlider(){ const r=getCurrent(); if(!r) return; const t=Number($('#masterTime').value); const lab=$('#masterTimeLabel'); if(lab) lab.textContent = t+'s'; const a=$('#vidA'), b=$('#vidB'); const ta=Math.max(0, t + Number(r.videos.A.offset||0)); const tb=Math.max(0, t + Number(r.videos.B.offset||0)); if(a && !isNaN(ta)) a.currentTime=ta; if(b && !isNaN(tb)) b.currentTime=tb; }
    function maybeLinkTimes(src){ const link=$('#linkTime'); if(!link || !link.checked) return; const r=getCurrent(); if(!r) return; const a=$('#vidA'), b=$('#vidB'); if(src===a){ const master=Math.max(0, a.currentTime - Number(r.videos.A.offset||0)); const mt=$('#masterTime'); if(mt) mt.value = master; const lab=$('#masterTimeLabel'); if(lab) lab.textContent = master+'s'; const target=Math.max(0, master + Number(r.videos.B.offset||0)); if(b && Math.abs(b.currentTime - target)>0.15) b.currentTime=target; } else { const master=Math.max(0, b.currentTime - Number(r.videos.B.offset||0)); const mt=$('#masterTime'); if(mt) mt.value = master; const lab=$('#masterTimeLabel'); if(lab) lab.textContent = master+'s'; const target=Math.max(0, master + Number(r.videos.A.offset||0)); if(a && Math.abs(a.currentTime - target)>0.15) a.currentTime=target; } }
    function abToggle(){ const a=$('#vidA'), b=$('#vidB'); if(!a||!b) return; if(a.style.opacity==='' || a.style.opacity==='1'){ a.style.opacity='0.25'; b.style.opacity='1'; } else { a.style.opacity='1'; b.style.opacity='0.25'; } }
    async function captureCurrentFrameIntoImages(){ const r=getCurrent(); if(!r) return; const a=$('#vidA'), b=$('#vidB'); const src=(a && a.paused? b : a) || a || b; if(!src || src.readyState<2){ alert('재생 가능한 영상이 필요합니다.'); return; } const canvas=document.createElement('canvas'); canvas.width=src.videoWidth; canvas.height=src.videoHeight; const ctx=canvas.getContext('2d'); ctx.drawImage(src,0,0); const dataUrl=canvas.toDataURL('image/jpeg',0.85); const blob=await (await fetch(dataUrl)).blob(); const key='b_'+Math.random().toString(36).slice(2); await idb.put(key, blob); r.images.push({ id:'img_'+Date.now(), blobKey:key, caption:`프레임 캡처 (${new Date().toLocaleString()})`, thumbDataUrl:dataUrl }); saveState(); renderImages(); }

    // ========= Events & Bindings =========
    function bindInputs(){
      // Tabs
      $$('.tab-btn').forEach(btn=>{ btn.addEventListener('click', ()=>{ const id=btn.dataset.tab; $$('.tab-btn').forEach(b=> b.classList.remove('bg-slate-100','font-semibold')); btn.classList.add('bg-slate-100','font-semibold'); $$('.tab-pane').forEach(p=> p.classList.add('hidden')); const pane=$('#'+id); if(pane) pane.classList.remove('hidden'); }); });

      // Basic fields
      const handlers = [['reportTitle','title'],['dateKST','dateKST'],['project','project'],['location','location'],['operator','operator'],['gear','gear'],['summary','summary'],['process','process']];
      for(const [id,key] of handlers){ const el=$('#'+id); if(el) el.addEventListener('input', ()=>{ const r=getCurrent(); if(!r) return; r[key]=el.value; saveState(); }); }

      // Metrics/Results
      const m=[['metricEV','EV'],['metricSNR','SNR'],['metricCCT','CCT'],['metricTint','Tint'],['metricMTF','MTF'],['metricISO','ISO'],['metricShutter','Shutter'],['metricAperture','Aperture'],['metricGamma','Gamma'],['metricLUT','LUT']];
      m.forEach(([id, mk])=>{ const el=$('#'+id); if(el) el.addEventListener('input', ()=>{ const r=getCurrent(); if(!r) return; r.metrics[mk]=el.value; saveState(); }); });
      const rs=[['resultSummary','resultSummary'],['nextActions','nextActions']];
      rs.forEach(([id,key])=>{ const el=$('#'+id); if(el) el.addEventListener('input', ()=>{ const r=getCurrent(); if(!r) return; r[key]=el.value; saveState(); }); });

      // QC
      const qc = $('#qcList'); if(qc) qc.addEventListener('change', (e)=>{ if(!e.target.classList.contains('qcCheck')) return; const r=getCurrent(); if(!r) return; const idx=Number(e.target.dataset.idx); r.qc[idx].v=e.target.checked; saveState(); });

      // Images
      const imgInput=$('#imgInput'); if(imgInput) imgInput.addEventListener('change', async (e)=>{ const files=Array.from(e.target.files||[]); const r=getCurrent(); if(!r) return; for(const f of files){ const key='b_'+Math.random().toString(36).slice(2); await idb.put(key, f); const thumb=await fileToThumb(f,800,800); r.images.push({ id:'img_'+Date.now()+Math.random(), blobKey:key, caption:f.name, thumbDataUrl:thumb }); } e.target.value=''; saveState(); renderImages(); });

      // Video inputs
      const aIn=$('#vidAInput'), bIn=$('#vidBInput'); if(aIn) aIn.addEventListener('change', async (e)=>{ const f=e.target.files?.[0]; if(!f) return; const r=getCurrent(); if(!r) return; const key='b_'+Math.random().toString(36).slice(2); await idb.put(key, f); r.videos.A={ name:f.name, blobKey:key, offset:Number($('#vidAOffset').value)||0 }; saveState(); loadVideo('A'); });
      if(bIn) bIn.addEventListener('change', async (e)=>{ const f=e.target.files?.[0]; if(!f) return; const r=getCurrent(); if(!r) return; const key='b_'+Math.random().toString(36).slice(2); await idb.put(key, f); r.videos.B={ name:f.name, blobKey:key, offset:Number($('#vidBOffset').value)||0 }; saveState(); loadVideo('B'); });
      const aOff=$('#vidAOffset'), bOff=$('#vidBOffset'); if(aOff) aOff.addEventListener('input', e=>{ const r=getCurrent(); if(!r) return; r.videos.A.offset=Number(e.target.value)||0; saveState(); }); if(bOff) bOff.addEventListener('input', e=>{ const r=getCurrent(); if(!r) return; r.videos.B.offset=Number(e.target.value)||0; saveState(); });

      // Video controls
      const pbr=$('#playbackRate'); if(pbr) pbr.addEventListener('change', e=> setPlaybackRate(Number(e.target.value)) );
      const mtime=$('#masterTime'); if(mtime) mtime.addEventListener('input', syncFromMasterSlider);
      const ab=$('#abToggle'); if(ab) ab.addEventListener('click', abToggle);
      const snap=$('#snapCurrent'); if(snap) snap.addEventListener('click', captureCurrentFrameIntoImages);
      const capBtn=$('#captureFromVideo'); if(capBtn) capBtn.addEventListener('click', captureCurrentFrameIntoImages);
      const va=$('#vidA'), vb=$('#vidB'); if(va) va.addEventListener('timeupdate', ()=> maybeLinkTimes(va)); if(vb) vb.addEventListener('timeupdate', ()=> maybeLinkTimes(vb));
      const syncChk=$('#syncPlay'); const sync=(evt)=>{ if(!syncChk || !syncChk.checked) return; const src=evt.target; const dst=src.id==='vidA'? $('#vidB'): $('#vidA'); if(!dst) return; if(evt.type==='play'){ dst.play().catch(()=>{});} if(evt.type==='pause'){ dst.pause(); } }; if(va){ va.addEventListener('play', sync); va.addEventListener('pause', sync);} if(vb){ vb.addEventListener('play', sync); vb.addEventListener('pause', sync);}    

      // Global actions
      const newBtn=$('#newReportBtn'); if(newBtn) newBtn.addEventListener('click', ()=>{ const r=createEmptyReport(); state.reports.push(r); setCurrent(r.id); });
      const printBtn=$('#printBtn'); if(printBtn) printBtn.addEventListener('click', ()=> window.print());

      // Keyboard shortcut for A/B toggle
      document.addEventListener('keydown', (e)=>{ if(e.key==='Tab' && !e.shiftKey){ e.preventDefault(); abToggle(); } });
    }

    // ========= Calendar =========
    function renderCalendar(){ const container=$('#calendarContainer'); if(!container) return; const now=new Date(); const year=now.getFullYear(); const month=now.getMonth(); const firstDay=new Date(year,month,1); const lastDay=new Date(year,month+1,0); let html='<table class="calendar"><thead><tr>'; const days=['일','월','화','수','목','금','토']; for(const d of days) html+='<th>'+d+'</th>'; html+='</tr></thead><tbody><tr>'; for(let i=0;i<firstDay.getDay();i++){ html+='<td></td>'; } for(let d=1;d<=lastDay.getDate();d++){ const dateStr=year+'-'+String(month+1).padStart(2,'0')+'-'+String(d).padStart(2,'0'); const marked=state.reports.some(r=>(r.dateKST||'').startsWith(dateStr)); html+='<td class="'+(marked?'marked':'')+'">'+d+'</td>'; if((firstDay.getDay()+d)%7===0) html+='</tr><tr>'; } html+='</tr></tbody></table>'; container.innerHTML=html; }

    // ========= Helpers =========
    function escapeHtml(s=''){ return s.replace(/[&<>"']/g, c=>({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'
    }[c])); }
    function downloadBlob(blob, filename){ const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); URL.revokeObjectURL(a.href); }
    async function fileToThumb(file, maxW=800, maxH=800){ const dataUrl=await blobToDataURL(file); const img=new Image(); img.src=dataUrl; await img.decode(); const ratio=Math.min(maxW/img.width, maxH/img.height, 1); const canvas=document.createElement('canvas'); canvas.width=Math.round(img.width*ratio); canvas.height=Math.round(img.height*ratio); const ctx=canvas.getContext('2d'); ctx.drawImage(img,0,0,canvas.width,canvas.height); return canvas.toDataURL('image/jpeg',0.85); }
    function blobToDataURL(blob){ return new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(blob); }); }

    // ========= Boot =========
    const origSave = saveState; saveState = function(){ origSave(); renderCalendar(); };
    function boot(){
      loadState();
      if(!state.reports.length){ const r=createEmptyReport(); state.reports.push(r); state.currentId=r.id; saveState(); }
      else if(!state.currentId){ state.currentId=state.reports[0].id; saveState(); }
      renderReportList(); bindInputs(); renderEditor(); renderCalendar();
    }
    document.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
