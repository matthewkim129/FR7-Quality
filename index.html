<!DOCTYPE html>
<html lang="ko" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FR7 일일 품질개선 보고</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .thin-scroll::-webkit-scrollbar{width:8px;height:8px}
    .thin-scroll::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:6px}
    .thin-scroll::-webkit-scrollbar-track{background:transparent}
    .drag-over{outline:2px dashed #60a5fa; outline-offset:4px}
    table.calendar {border-collapse: collapse; width: 100%;}
    table.calendar th, table.calendar td {border: 1px solid #e2e8f0; text-align: center; padding: 4px; font-size: 12px;}
    table.calendar td.marked {background-color:#bfdbfe; font-weight:bold;}
    /* 16:9 container */
    .ratio-16x9 { aspect-ratio: 16 / 9; }
    .cmp-box { background:#000; }
    .cmp-box img { width:100%; height:100%; object-fit:contain; }
  </style>
</head>
<body class="h-full bg-slate-50 text-slate-900">
  <div id="app" class="h-full flex">
    <!-- Sidebar -->
    <aside class="w-80 bg-white border-r border-slate-200 flex flex-col">
      <div class="p-4 border-b flex items-center justify-between">
        <h1 class="text-lg font-bold">FR7 일일 보고</h1>
      </div>
      <div class="p-3 border-b space-y-2">
        <button id="newReportBtn" class="w-full py-2 rounded-xl bg-blue-600 text-white font-semibold hover:bg-blue-700">+ 새 보고서</button>
        <button id="printBtn" class="w-full py-2 rounded-xl bg-slate-700 text-white text-sm hover:bg-slate-800">인쇄 / PDF</button>
      </div>

      <div id="reportList" class="flex-1 overflow-y-auto thin-scroll divide-y"></div>
      <div class="p-3 border-t">
        <h2 class="text-sm font-semibold mb-2">달력</h2>
        <div id="calendarContainer"></div>
      </div>
      <div class="p-3 text-xs text-slate-400 border-t">로컬 저장소(LocalStorage/IndexedDB)에 저장됩니다.</div>
    </aside>

    <!-- Main -->
    <main class="flex-1 overflow-hidden">
      <!-- Top bar -->
      <div class="px-5 py-3 bg-white border-b flex items-center gap-3">
        <input id="reportTitle" class="text-lg font-bold flex-1 outline-none bg-transparent" placeholder="보고서 제목 (예: 2025-08-27 FR7 품질개선 일일 보고)" />
        <div id="autosaveState" class="text-xs text-slate-500">저장 상태: -</div>
      </div>

      <!-- Tabs -->
      <div class="px-5 pt-4 bg-white border-b">
        <div class="flex gap-2 text-sm">
          <button data-tab="tab-summary" class="tab-btn px-3 py-2 rounded-t bg-slate-100 font-semibold">요약</button>
          <button data-tab="tab-detail" class="tab-btn px-3 py-2 rounded-t">세부</button>
        </div>
      </div>

      <!-- 요약 -->
      <section id="tab-summary" class="tab-pane p-5 overflow-y-auto thin-scroll h-[calc(100vh-136px)]">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <div class="bg-white rounded-xl shadow p-4">
            <h2 class="font-semibold mb-3">기본 정보</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
              <label class="space-y-1">
                <span class="text-slate-600">보고 날짜 (KST)</span>
                <input id="dateKST" type="text" class="w-full rounded border p-2" />
              </label>
              <label class="space-y-1">
                <span class="text-slate-600">프로젝트</span>
                <input id="project" type="text" class="w-full rounded border p-2" placeholder="예: WSOP SC Cyprus 2025"/>
              </label>
              <label class="space-y-1 md:col-span-2">
                <span class="text-slate-600">촬영 장소/환경</span>
                <input id="location" type="text" class="w-full rounded border p-2" placeholder="예: 피처테이블 존, 실내 3200K 조명"/>
              </label>
              <label class="space-y-1">
                <span class="text-slate-600">담당자</span>
                <input id="operator" type="text" class="w-full rounded border p-2" placeholder="예: Trey"/>
              </label>
              <label class="space-y-1">
                <span class="text-slate-600">카메라/렌즈</span>
                <input id="gear" type="text" class="w-full rounded border p-2" placeholder="예: Sony FR7 + 28–135mm F4, 펌웨어 vX.Y"/>
              </label>
            </div>
          </div>

          <div class="bg-white rounded-xl shadow p-4">
            <h2 class="font-semibold mb-3">체크리스트 (QC: 품질관리)</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-x-4 gap-y-2 text-sm" id="qcList"></div>
          </div>

          <div class="bg-white rounded-xl shadow p-4 md:col-span-2">
            <h2 class="font-semibold mb-3">오늘의 요약</h2>
            <textarea id="summary" class="w-full min-h-32 rounded border p-3 text-sm" placeholder="핵심 목표, 주요 변경점, 결과 개요를 간단히 정리"></textarea>
          </div>
        </div>
      </section>

      <!-- 세부 -->
      <section id="tab-detail" class="tab-pane hidden p-5 overflow-y-auto thin-scroll h-[calc(100vh-136px)]">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
          <!-- 과정 -->
          <div class="bg-white rounded-xl shadow p-4">
            <h2 class="font-semibold mb-2">과정</h2>
            <textarea id="process" class="w-full min-h-40 rounded border p-3 text-sm" placeholder="이전 진행 사항 / 오늘 수정·시도 / 새롭게 알게 된 점 / 문제 & 해결"></textarea>
          </div>

          <!-- 결과·측정 -->
          <div class="bg-white rounded-xl shadow p-4">
            <h2 class="font-semibold mb-3">결과·측정</h2>
            <div class="grid grid-cols-2 gap-3 text-sm">
              <label class="space-y-1"><span class="text-slate-600">EV</span><input id="metricEV" type="number" step="0.01" class="w-full rounded border p-2"/></label>
              <label class="space-y-1"><span class="text-slate-600">SNR</span><input id="metricSNR" type="number" step="0.1" class="w-full rounded border p-2"/></label>
              <label class="space-y-1"><span class="text-slate-600">ΔCCT</span><input id="metricCCT" type="number" step="1" class="w-full rounded border p-2"/></label>
              <label class="space-y-1"><span class="text-slate-600">ΔTint</span><input id="metricTint" type="number" step="0.1" class="w-full rounded border p-2"/></label>
              <label class="space-y-1"><span class="text-slate-600">MTF50</span><input id="metricMTF" type="number" step="0.1" class="w-full rounded border p-2"/></label>
              <label class="space-y-1"><span class="text-slate-600">ISO</span><input id="metricISO" type="number" class="w-full rounded border p-2"/></label>
              <label class="space-y-1"><span class="text-slate-600">셔터</span><input id="metricShutter" type="text" class="w-full rounded border p-2" placeholder="예: 1/100 또는 180°"/></label>
              <label class="space-y-1"><span class="text-slate-600">조리개</span><input id="metricAperture" type="text" class="w-full rounded border p-2" placeholder="예: F4.0"/></label>
              <label class="space-y-1 md:col-span-2"><span class="text-slate-600">감마/픽처 프로파일</span><input id="metricGamma" type="text" class="w-full rounded border p-2" placeholder="예: S‑Cinetone, S‑Log3 등"/></label>
              <label class="space-y-1 md:col-span-2"><span class="text-slate-600">사용 LUT</span><input id="metricLUT" type="text" class="w-full rounded border p-2" placeholder="예: 709 LUT v2"/></label>
            </div>
            <div class="mt-3 space-y-3">
              <textarea id="resultSummary" class="w-full min-h-24 rounded border p-3 text-sm" placeholder="결과 요약"></textarea>
              <textarea id="nextActions" class="w-full min-h-20 rounded border p-3 text-sm" placeholder="다음 액션"></textarea>
            </div>
          </div>

          <!-- 캡처 그리드 -->
          <div class="bg-white rounded-xl shadow p-4 lg:col-span-2">
            <div class="flex items-center justify-between mb-3">
              <h2 class="font-semibold">캡처</h2>
              <label class="cursor-pointer text-sm px-3 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">
                이미지 추가
                <input id="imgInput" type="file" accept="image/*" multiple class="hidden">
              </label>
            </div>
            <div id="imgGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4"></div>
          </div>

          <!-- 이미지 비교 (좌우, 16:9) -->
          <div class="bg-white rounded-xl shadow p-4 lg:col-span-2">
            <div class="flex items-center justify-between mb-3">
              <h2 class="font-semibold">이미지 비교 (A / B)</h2>
              <div class="flex gap-2">
                <label class="cursor-pointer text-xs px-2 py-1 rounded bg-slate-700 text-white hover:bg-slate-800">A 선택
                  <input id="cmpAInput" type="file" accept="image/*" class="hidden">
                </label>
                <label class="cursor-pointer text-xs px-2 py-1 rounded bg-slate-700 text-white hover:bg-slate-800">B 선택
                  <input id="cmpBInput" type="file" accept="image/*" class="hidden">
                </label>
                <button id="swapAB" class="text-xs px-2 py-1 rounded bg-slate-100">A↔B 교체</button>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div class="cmp-box ratio-16x9 rounded-lg overflow-hidden flex items-center justify-center">
                <img id="cmpA" alt="비교 A" />
              </div>
              <div class="cmp-box ratio-16x9 rounded-lg overflow-hidden flex items-center justify-center">
                <img id="cmpB" alt="비교 B" />
              </div>
            </div>
            <div class="mt-2 text-xs text-slate-500" id="cmpNames"></div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // ========= Utilities =========
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
    const KST = {
      nowString(){ return new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul', hour12: false }); },
      todayISO(){ const d = new Date(new Date().toLocaleString('en-US', { timeZone: 'Asia/Seoul' })); return d.toISOString().slice(0,10); }
    };

    // ========= State =========
    const LS_KEY = 'fr7-daily-reports-v3';
    let state = { reports: [], currentId: null };
    function loadState(){ try{ const raw = localStorage.getItem(LS_KEY); if(raw){ state = JSON.parse(raw); } }catch(e){ console.warn('loadState error', e); } }
    function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); const s=$('#autosaveState'); if(s) s.textContent = '저장 상태: ' + new Date().toLocaleTimeString(); }

    // ========= IndexedDB for blobs =========
    const idb = (()=>{ let db; function open(){ return new Promise((resolve, reject)=>{ const req = indexedDB.open('fr7ReportsDB', 1); req.onupgradeneeded = e=>{ db = e.target.result; if(!db.objectStoreNames.contains('blobs')) db.createObjectStore('blobs'); }; req.onsuccess = e=>{ db = e.target.result; resolve(); }; req.onerror = e=>reject(e); }); }
      async function put(key, data){ await openIfNeeded(); return new Promise((res,rej)=>{ const tx=db.transaction('blobs','readwrite'); tx.objectStore('blobs').put(data, key); tx.oncomplete=()=>res(); tx.onerror=e=>rej(e); }); }
      async function get(key){ await openIfNeeded(); return new Promise((res,rej)=>{ const tx=db.transaction('blobs','readonly'); const rq=tx.objectStore('blobs').get(key); rq.onsuccess=()=>res(rq.result); rq.onerror=e=>rej(e); }); }
      async function del(key){ await openIfNeeded(); return new Promise((res,rej)=>{ const tx=db.transaction('blobs','readwrite'); tx.objectStore('blobs').delete(key); tx.oncomplete=()=>res(); tx.onerror=e=>rej(e); }); }
      async function openIfNeeded(){ if(!db) await open(); } return { put, get, del }; })();

    // ========= Model =========
    function createEmptyReport(){
      const id = 'r_' + Math.random().toString(36).slice(2);
      return {
        id,
        title: KST.todayISO() + ' FR7 품질개선 일일 보고',
        dateKST: KST.nowString(),
        project: '', location: '', operator: '', gear: '',
        qc: defaultQC().map(x=>({ ...x })),
        summary: '', process: '',
        metrics: { EV:'', SNR:'', CCT:'', Tint:'', MTF:'', ISO:'', Shutter:'', Aperture:'', Gamma:'', LUT:'' },
        resultSummary:'', nextActions:'',
        images: [], // {id, blobKey, caption, thumbDataUrl}
        compare: { A: { name:'', blobKey:null }, B: { name:'', blobKey:null } }
      };
    }
    function defaultQC(){ return [
      { k:'초점', v:false }, { k:'노출', v:false }, { k:'WB 일치', v:false }, { k:'컬러 매칭', v:false },
      { k:'노이즈', v:false }, { k:'플리커', v:false }, { k:'롤링 셔터', v:false }, { k:'샤프니스', v:false },
      { k:'스태빌라이징', v:false }, { k:'스킨 톤', v:false }, { k:'하이라이트 보존', v:false }, { k:'섀도우 디테일', v:false }
    ]; }

    function getCurrent(){ return state.reports.find(r=>r.id===state.currentId) || null; }
    function setCurrent(id){ state.currentId = id; saveState(); renderReportList(); renderEditor(); }

    // ========= Rendering =========
    function renderReportList(){
      const box = $('#reportList'); if(!box) return; box.innerHTML = '';
      const sorted = [...state.reports].sort((a,b)=> (b.dateKST||'').localeCompare(a.dateKST||''));
      for(const r of sorted){
        const isActive = r.id===state.currentId;
        const item = document.createElement('button');
        item.className = 'w-full text-left p-3 hover:bg-slate-50 ' + (isActive?'bg-blue-50':'');
        item.innerHTML = `<div class="font-semibold truncate">${escapeHtml(r.title||'(제목 없음)')}</div><div class="text-xs text-slate-500">${escapeHtml(r.dateKST||'')}</div>`;
        item.onclick = ()=> setCurrent(r.id);
        box.appendChild(item);
      }
    }

    function renderEditor(){
      const r = getCurrent();
      const disabled = !r;
      const ids = ['reportTitle','dateKST','project','location','operator','gear','summary','process','metricEV','metricSNR','metricCCT','metricTint','metricMTF','metricISO','metricShutter','metricAperture','metricGamma','metricLUT','resultSummary','nextActions'];
      ids.forEach(id=>{ const node = document.getElementById(id); if(node) node.disabled = disabled; });
      if(!r) return;

      // Fill fields
      $('#reportTitle').value = r.title||''; $('#dateKST').value = r.dateKST||KST.nowString();
      $('#project').value = r.project||''; $('#location').value = r.location||''; $('#operator').value = r.operator||''; $('#gear').value = r.gear||'';
      $('#summary').value = r.summary||''; $('#process').value = r.process||'';
      $('#metricEV').value = r.metrics.EV||''; $('#metricSNR').value = r.metrics.SNR||''; $('#metricCCT').value = r.metrics.CCT||''; $('#metricTint').value = r.metrics.Tint||''; $('#metricMTF').value = r.metrics.MTF||''; $('#metricISO').value = r.metrics.ISO||''; $('#metricShutter').value = r.metrics.Shutter||''; $('#metricAperture').value = r.metrics.Aperture||''; $('#metricGamma').value = r.metrics.Gamma||''; $('#metricLUT').value = r.metrics.LUT||'';
      $('#resultSummary').value = r.resultSummary||''; $('#nextActions').value = r.nextActions||'';
      const dd = $('#detailDone'); if(dd) dd.checked = !!(r.flags&&r.flags.detailDone);

      // QC
      const qcBox = $('#qcList'); if(qcBox){ qcBox.innerHTML = ''; (r.qc?.length? r.qc: defaultQC()).forEach((row, idx)=>{ const wrap = document.createElement('label'); wrap.className = 'inline-flex items-center gap-2'; wrap.innerHTML = `<input type=\"checkbox\" ${row.v?'checked':''} data-idx=\"${idx}\" class=\"qcCheck\"> <span class=\"text-slate-700\">${escapeHtml(row.k)}</span>`; qcBox.appendChild(wrap); }); }

      // Captures
      renderImages();
      // Compare
      loadCompare('A'); loadCompare('B');
    }

    function renderImages(){
      const r = getCurrent(); const grid = $('#imgGrid'); if(!grid) return; grid.innerHTML = '';
      (r?.images||[]).forEach((img, idx)=>{
        const card = document.createElement('div'); card.className = 'bg-white rounded-xl shadow p-3 space-y-2';
        card.draggable = true; card.addEventListener('dragstart', e=>{ e.dataTransfer.setData('text/plain', idx); card.classList.add('opacity-50'); }); card.addEventListener('dragend', ()=> card.classList.remove('opacity-50'));
        card.addEventListener('dragover', e=>{ e.preventDefault(); card.classList.add('drag-over'); }); card.addEventListener('dragleave', ()=> card.classList.remove('drag-over'));
        card.addEventListener('drop', async e=>{ e.preventDefault(); card.classList.remove('drag-over'); const from = parseInt(e.dataTransfer.getData('text/plain'),10); const to = idx; if(from===to) return; const moved = r.images.splice(from,1)[0]; r.images.splice(to,0,moved); saveState(); renderImages(); });
        const imgEl = document.createElement('img'); imgEl.className = 'w-full h-40 object-cover rounded'; imgEl.src = img.thumbDataUrl || ''; imgEl.alt = img.caption || '';
        const cap = document.createElement('input'); cap.className = 'w-full text-xs border rounded p-2'; cap.placeholder='캡션'; cap.value = img.caption||''; cap.oninput = ()=>{ img.caption = cap.value; saveState(); };
        const row = document.createElement('div'); row.className='flex items-center justify-between text-xs';
        const btns = document.createElement('div'); btns.className='flex gap-2';
        const upBtn=document.createElement('button'); upBtn.textContent='▲'; upBtn.className='px-2 py-1 rounded bg-slate-100';
        const dnBtn=document.createElement('button'); dnBtn.textContent='▼'; dnBtn.className='px-2 py-1 rounded bg-slate-100';
        const delBtn=document.createElement('button'); delBtn.textContent='삭제'; delBtn.className='px-2 py-1 rounded bg-red-600 text-white';
        upBtn.onclick=()=>{ if(idx>0){ const t=r.images[idx-1]; r.images[idx-1]=r.images[idx]; r.images[idx]=t; saveState(); renderImages(); } };
        dnBtn.onclick=()=>{ if(idx<r.images.length-1){ const t=r.images[idx+1]; r.images[idx+1]=r.images[idx]; r.images[idx]=t; saveState(); renderImages(); } };
        delBtn.onclick= async ()=>{ if(confirm('이미지를 삭제할까요?')){ await idb.del(img.blobKey); r.images.splice(idx,1); saveState(); renderImages(); } };
        btns.append(upBtn,dnBtn,delBtn); row.append(document.createElement('span'), btns);
        card.append(imgEl, cap, row); grid.appendChild(card);
      });
    }

    // ========= Compare (Image A/B) =========
    async function loadCompare(which){
      const r = getCurrent(); if(!r) return;
      const c = r.compare[which]; const imgEl = which==='A'? $('#cmpA'): $('#cmpB'); const names = $('#cmpNames');
      if(!imgEl) return;
      imgEl.src = '';
      if(c && c.blobKey){ const blob = await idb.get(c.blobKey); if(blob){ imgEl.src = URL.createObjectURL(blob); } }
      if(names){ names.textContent = `${r.compare.A?.name||''}  |  ${r.compare.B?.name||''}`.trim(); }
    }

    // ========= Events =========
    function bindInputs(){
      // Tabs
      $$('.tab-btn').forEach(btn=>{ btn.addEventListener('click', ()=>{ const id=btn.dataset.tab; $$('.tab-btn').forEach(b=> b.classList.remove('bg-slate-100','font-semibold')); btn.classList.add('bg-slate-100','font-semibold'); $$('.tab-pane').forEach(p=> p.classList.add('hidden')); const pane=$('#'+id); if(pane) pane.classList.remove('hidden'); }); });

      // Basic fields
      const handlers = [['reportTitle','title'],['dateKST','dateKST'],['project','project'],['location','location'],['operator','operator'],['gear','gear'],['summary','summary'],['process','process']];
      for(const [id,key] of handlers){ const el=$('#'+id); if(el) el.addEventListener('input', ()=>{ const r=getCurrent(); if(!r) return; r[key]=el.value; saveState(); }); }

      // Metrics/Results
      const m=[['metricEV','EV'],['metricSNR','SNR'],['metricCCT','CCT'],['metricTint','Tint'],['metricMTF','MTF'],['metricISO','ISO'],['metricShutter','Shutter'],['metricAperture','Aperture'],['metricGamma','Gamma'],['metricLUT','LUT']];
      m.forEach(([id, mk])=>{ const el=$('#'+id); if(el) el.addEventListener('input', ()=>{ const r=getCurrent(); if(!r) return; r.metrics[mk]=el.value; saveState(); }); });
      const rs=[['resultSummary','resultSummary'],['nextActions','nextActions']];
      rs.forEach(([id,key])=>{ const el=$('#'+id); if(el) el.addEventListener('input', ()=>{ const r=getCurrent(); if(!r) return; r[key]=el.value; saveState(); }); });

      // QC
      const qc = $('#qcList'); if(qc) qc.addEventListener('change', (e)=>{ if(!e.target.classList.contains('qcCheck')) return; const r=getCurrent(); if(!r) return; const idx=Number(e.target.dataset.idx); r.qc[idx].v=e.target.checked; saveState(); });

      // Images grid
      const imgInput=$('#imgInput'); if(imgInput) imgInput.addEventListener('change', async (e)=>{ const files=Array.from(e.target.files||[]); const r=getCurrent(); if(!r) return; for(const f of files){ const key='b_'+Math.random().toString(36).slice(2); await idb.put(key, f); const thumb=await fileToThumb(f,800,800); r.images.push({ id:'img_'+Date.now()+Math.random(), blobKey:key, caption:f.name, thumbDataUrl:thumb }); } e.target.value=''; saveState(); renderImages(); });

      // Compare inputs
      const aIn=$('#cmpAInput'), bIn=$('#cmpBInput');
      if(aIn) aIn.addEventListener('change', async (e)=>{ const f=e.target.files?.[0]; if(!f) return; const r=getCurrent(); if(!r) return; const key='b_'+Math.random().toString(36).slice(2); await idb.put(key, f); r.compare.A={ name:f.name, blobKey:key }; saveState(); loadCompare('A'); });
      if(bIn) bIn.addEventListener('change', async (e)=>{ const f=e.target.files?.[0]; if(!f) return; const r=getCurrent(); if(!r) return; const key='b_'+Math.random().toString(36).slice(2); await idb.put(key, f); r.compare.B={ name:f.name, blobKey:key }; saveState(); loadCompare('B'); });

      // Swap A/B
      const swap=$('#swapAB'); if(swap) swap.addEventListener('click', ()=>{ const r=getCurrent(); if(!r) return; const t=r.compare.A; r.compare.A=r.compare.B; r.compare.B=t; saveState(); loadCompare('A'); loadCompare('B'); });

      // Global actions
      const newBtn=$('#newReportBtn'); if(newBtn) newBtn.addEventListener('click', ()=>{ const r=createEmptyReport(); state.reports.push(r); setCurrent(r.id); });
      const printBtn=$('#printBtn'); if(printBtn) printBtn.addEventListener('click', ()=> window.print());
    }

    // ========= Calendar =========
    function renderCalendar(){ const container=$('#calendarContainer'); if(!container) return; const now=new Date(); const year=now.getFullYear(); const month=now.getMonth(); const firstDay=new Date(year,month,1); const lastDay=new Date(year,month+1,0); let html='<table class="calendar"><thead><tr>'; const days=['일','월','화','수','목','금','토']; for(const d of days) html+='<th>'+d+'</th>'; html+='</tr></thead><tbody><tr>'; for(let i=0;i<firstDay.getDay();i++){ html+='<td></td>'; } for(let d=1;d<=lastDay.getDate();d++){ const dateStr=year+'-'+String(month+1).padStart(2,'0')+'-'+String(d).padStart(2,'0'); const marked=state.reports.some(r=>(r.dateKST||'').startsWith(dateStr)); html+='<td class="'+(marked?'marked':'')+'">'+d+'</td>'; if((firstDay.getDay()+d)%7===0) html+='</tr><tr>'; } html+='</tr></tbody></table>'; container.innerHTML=html; }

    // ========= Helpers =========
    function escapeHtml(s=''){ return s.replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }
    async function fileToThumb(file, maxW=800, maxH=800){ const dataUrl=await blobToDataURL(file); const img=new Image(); img.src=dataUrl; await img.decode(); const ratio=Math.min(maxW/img.width, maxH/img.height, 1); const canvas=document.createElement('canvas'); canvas.width=Math.round(img.width*ratio); canvas.height=Math.round(img.height*ratio); const ctx=canvas.getContext('2d'); ctx.drawImage(img,0,0,canvas.width,canvas.height); return canvas.toDataURL('image/jpeg',0.85); }
    function blobToDataURL(blob){ return new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(blob); }); }

    // ========= Boot =========
    const origSave = saveState; saveState = function(){ origSave(); renderCalendar(); };
    function boot(){
      loadState();
      if(!state.reports.length){ const r=createEmptyReport(); state.reports.push(r); state.currentId=r.id; saveState(); }
      else if(!state.currentId){ state.currentId=state.reports[0].id; saveState(); }
      renderReportList(); bindInputs(); renderEditor(); renderCalendar();
    }
    document.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
